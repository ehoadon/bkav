<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ So sánh File Excel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 1000px;
            margin: auto;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
        }
        input {
            padding: 8px;
            width: 100%;
            max-width: 300px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .result {
            margin-top: 20px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Công cụ So sánh File Excel</h1>
        
        <div class="section">
            <h2>1. Tải file Excel</h2>
            <label>Chọn File 1:</label>
            <input type="file" id="file1" accept=".xlsx, .xls">
            <label>Chọn File 2:</label>
            <input type="file" id="file2" accept=".xlsx, .xls">
        </div>

        <button onclick="compareFiles()">So sánh</button>

        <div class="result" id="result"></div>
    </div>

    <script>
        let data1 = null, data2 = null;

        document.getElementById('file1').addEventListener('change', handleFileSelect);
        document.getElementById('file2').addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const workbook = XLSX.read(event.target.result, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                console.log(`Data from ${e.target.id}:`, jsonData);
                if (e.target.id === 'file1') {
                    data1 = jsonData;
                } else {
                    data2 = jsonData;
                }
            };
            reader.readAsBinaryString(file);
        }

        function findColumnIndex(headers, columnName) {
            const index = headers.findIndex(header => header && header.toString().trim().toLowerCase() === columnName.toLowerCase());
            console.log(`Finding column ${columnName}, index: ${index}`);
            return index;
        }

        function compareFiles() {
            if (!data1 || !data2) {
                document.getElementById('result').innerHTML = '<p class="error">Vui lòng tải cả hai file Excel!</p>';
                return;
            }

            const headers1 = data1[0] || [];
            const headers2 = data2[0] || [];
            console.log('Headers in File 1:', headers1);
            console.log('Headers in File 2:', headers2);

            const billcodeCol1 = findColumnIndex(headers1, 'chk_num');
            const valueCol1 = findColumnIndex(headers1, 'sub_ttl');
            const otherSvcCol = findColumnIndex(headers1, 'other_svc_ttl');
            const conditionCols = {
                standaloneCheck: findColumnIndex(headers1, 'standalone_check'),
                summTtlPrntd: findColumnIndex(headers1, 'summ_ttl_prntd'),
                fastTransChk: findColumnIndex(headers1, 'fast_trans_chk'),
                chkCancelled: findColumnIndex(headers1, 'chk_cancelled'),
                chkEdited: findColumnIndex(headers1, 'chk_edited'),
                training: findColumnIndex(headers1, 'training')
            };
            console.log('Condition Columns:', conditionCols);

            const billcodeCol2 = findColumnIndex(headers2, 'mã bill');
            const valueCol2 = findColumnIndex(headers2, 'thành tiền');

            if (billcodeCol1 === -1 || valueCol1 === -1) {
                document.getElementById('result').innerHTML = '<p class="error">File 1 thiếu cột chk_num hoặc sub_ttl!</p>';
                return;
            }
            if (billcodeCol2 === -1 || valueCol2 === -1) {
                document.getElementById('result').innerHTML = '<p class="error">File 2 thiếu cột Mã bill hoặc Thành tiền!</p>';
                return;
            }

            const excludedBills = [];
            const validRows1 = data1.slice(1).filter(row => {
                const reasons = [];
                const billcode = row[billcodeCol1];
                console.log(`Row data for billcode ${billcode}:`, row);
                if (conditionCols.standaloneCheck !== -1 && row[conditionCols.standaloneCheck] != null) {
                    const rawVal = row[conditionCols.standaloneCheck];
                    const val = parseInt(rawVal, 10);
                    console.log(`standalone_check raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('standalone_check = 1');
                }
                if (conditionCols.summTtlPrntd !== -1 && row[conditionCols.summTtlPrntd] != null) {
                    const rawVal = row[conditionCols.summTtlPrntd];
                    const val = parseInt(rawVal, 10);
                    console.log(`summ_ttl_prntd raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('summ_ttl_prntd = 1');
                }
                if (conditionCols.fastTransChk !== -1 && row[conditionCols.fastTransChk] != null) {
                    const rawVal = row[conditionCols.fastTransChk];
                    const val = parseInt(rawVal, 10);
                    console.log(`fast_trans_chk raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('fast_trans_chk = 1');
                }
                if (conditionCols.chkCancelled !== -1 && row[conditionCols.chkCancelled] != null) {
                    const rawVal = row[conditionCols.chkCancelled];
                    const val = parseInt(rawVal, 10);
                    console.log(`chk_cancelled raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('chk_cancelled = 1');
                }
                if (conditionCols.chkEdited !== -1 && row[conditionCols.chkEdited] != null) {
                    const rawVal = row[conditionCols.chkEdited];
                    const val = parseInt(rawVal, 10);
                    console.log(`chk_edited raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('chk_edited = 1');
                }
                if (conditionCols.training !== -1 && row[conditionCols.training] != null) {
                    const rawVal = row[conditionCols.training];
                    const val = parseInt(rawVal, 10);
                    console.log(`training raw: ${rawVal}, parsed: ${val}`);
                    if (!isNaN(val) && val === 1) reasons.push('training = 1');
                }

                if (reasons.length > 0) {
                    excludedBills.push({ billcode: billcode, reason: reasons.join(', ') });
                    return false;
                }
                return true;
            });
            console.log('Excluded Bills:', excludedBills);

            const billcodes1 = data1.slice(1).map(row => String(row[billcodeCol1]).trim()).filter(b => b);
            const billcodes2 = data2.slice(1).map(row => String(row[billcodeCol2]).trim()).filter(b => b);
            console.log('Billcodes in File 1:', billcodes1);
            console.log('Billcodes in File 2:', billcodes2);

            const missingInFile2 = [];
            billcodes1.forEach(bill => {
                if (!billcodes2.includes(bill)) {
                    const row = data1.slice(1).find(r => String(r[billcodeCol1]).trim() === bill);
                    const excluded = excludedBills.find(e => e.billcode === bill);
                    if (excluded) {
                        missingInFile2.push({ billcode: bill, reason: excluded.reason, valid: true });
                    } else if (row[valueCol1] != null && parseFloat(row[valueCol1]) <= 0) {
                        missingInFile2.push({ billcode: bill, reason: 'sub_ttl <= 0', valid: true });
                    } else {
                        missingInFile2.push({ billcode: bill, reason: 'Không có trong File 2', valid: false });
                    }
                }
            });

            const valueDiffs = [];
            validRows1.forEach(row1 => {
                const billcode = String(row1[billcodeCol1]).trim();
                const row2 = data2.slice(1).find(r => String(r[billcodeCol2]).trim() === billcode);
                if (row2) {
                    const val1 = row1[valueCol1] != null ? parseFloat(row1[valueCol1]) || 0 : 0;
                    const val2 = row2[valueCol2] != null ? parseFloat(row2[valueCol2]) || 0 : 0;
                    const diff = val2 - val1;
                    if (diff !== 0) {
                        const otherSvc = otherSvcCol !== -1 && row1[otherSvcCol] != null ? parseFloat(row1[otherSvcCol]) || 0 : 0;
                        const isValidDiff = diff === otherSvc;
                        valueDiffs.push({ billcode, diff, isValidDiff, otherSvc });
                    }
                }
            });

            let resultHtml = '<h2>Kết quả so sánh</h2>';
            if (missingInFile2.length > 0) {
                resultHtml += '<h3>Billcode có ở File 1 nhưng không có ở File 2:</h3>';
                resultHtml += '<table><tr><th>Billcode</th><th>Lý do</th><th>Hợp lệ</th></tr>';
                missingInFile2.forEach(bill => {
                    resultHtml += `<tr><td>${bill.billcode}</td><td>${bill.reason}</td><td>${bill.valid ? 'Có' : 'Không'}</td></tr>`;
                });
                resultHtml += '</table>';
            } else {
                resultHtml += '<p>Không có Billcode nào chỉ xuất hiện ở File 1.</p>';
            }

            if (valueDiffs.length > 0) {
                resultHtml += '<h3>Billcode có giá trị chênh lệch:</h3>';
                resultHtml += '<table><tr><th>Billcode</th><th>Chênh lệch (Thành tiền - sub_ttl)</th><th>Hợp lệ (Bằng other_svc_ttl)</th></tr>';
                valueDiffs.forEach(diff => {
                    resultHtml += `<tr><td>${diff.billcode}</td><td>${diff.diff}</td><td>${diff.isValidDiff ? `Có (other_svc_ttl = ${diff.otherSvc})` : 'Không'}</td></tr>`;
                });
                resultHtml += '</table>';
            } else {
                resultHtml += '<p>Không có chênh lệch giá trị nào.</p>';
            }

            document.getElementById('result').innerHTML = resultHtml;
        }
    </script>
</body>
</html>