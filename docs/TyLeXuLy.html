<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nh·∫≠p D·ªØ Li·ªáu & Th·ªëng K√™ (RTDB)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #eef2f5; color: #333; }
    .container { max-width: 1000px; margin: 20px auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; justify-content: space-between; align-items: center; background: #3498db; color: #fff; padding: 12px 20px; }
    .header h2 { font-size: 1.4rem; }
    .header .user-controls { display: flex; align-items: center; gap: 10px; }
    .header .user-controls span { font-size: 0.95rem; }
    #btnLogout { display: none; background: #2980b9; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #fff; }
    #btnLogout:hover { background: #2273a5; }
    #mainSection { display: none; padding: 20px; }
    .layout { display: flex; gap: 20px; align-items: stretch; }
    .panel { background: #fafafa; border: 1px solid #ddd; border-radius: 6px; padding: 16px; display: flex; flex-direction: column; }
    .panel-left, .panel-right { flex: 1; }
    .panel-left table { flex: 1; width: 100%; }
    .panel-left button { margin-top: auto; }
    .panel-right { display: flex; flex-direction: column; }
    .panel-summary { flex: 0 0 auto; margin-bottom: 12px; }
    .panel-stats { flex: 1; display: flex; flex-direction: column; }
    .chart-container { flex: 1; margin-bottom: 12px; }
    .filter-controls { display: flex; gap: 8px; margin-top: auto; }
    .filter-controls input[type="month"] { width: 165px; }
    .filter-controls button { flex: 1; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.95rem; }
    th { background: #f0f0f0; }
    input[type="number"], input[type="email"], input[type="password"] { width: 100%; padding: 6px; border: 1px solid #bbb; border-radius: 4px; }
    button.full { width: 100%; }
    button.primary { background: #3498db; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    button.primary:hover { background: #2980b9; }
    button.success { background: #27ae60; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    button.success:hover { background: #219150; }
    button.secondary { background: #7f8c8d; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    button.secondary:hover { background: #6d7676; }
    .console { background: #222; color: #0f0; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; }
    .msg { color: #27ae60; text-align: center; font-size: 0.9rem; margin-top: 6px; }
    #lastEntryLog { text-align: center; font-style: italic; margin: 10px 0; }
    #authSection { padding: 20px; }
    #authSection input, #authSection button { max-width: 300px; margin: 8px auto; display: block; }
    .auth-links { text-align: center; margin-top: 12px; }
    .auth-links a { color: #3498db; text-decoration: none; margin: 0 10px; }
    .auth-links a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Nh·∫≠p D·ªØ Li·ªáu & Th·ªëng K√™</h2>
      <div class="user-controls">
        <span id="welcomeMsg"></span>
        <button id="btnLogout">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>
    <div id="authSection">
      <div id="loginForm">
        <h3 style="text-align:center; margin-bottom:12px;">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h3>
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="M·∫≠t kh·∫©u" />
        <button id="btnLogin" class="primary full">ƒêƒÉng nh·∫≠p</button>
        <div class="auth-links">
          <a href="#" id="showRegister">ƒêƒÉng k√Ω</a>
          <a href="#" id="showForgotPassword">Qu√™n m·∫≠t kh·∫©u?</a>
        </div>
        <div class="msg" id="authMsg"></div>
      </div>
      <div id="registerForm" style="display: none;">
        <h3 style="text-align:center; margin-bottom:12px;">ƒêƒÉng k√Ω t√†i kho·∫£n</h3>
        <input id="regEmail" type="email" placeholder="Email" />
        <input id="regPassword" type="password" placeholder="M·∫≠t kh·∫©u" />
        <input id="regConfirmPassword" type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" />
        <button id="btnRegister" class="primary full">ƒêƒÉng k√Ω</button>
        <div class="auth-links">
          <a href="#" id="showLoginFromRegister">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
        </div>
        <div class="msg" id="registerMsg"></div>
      </div>
      <div id="forgotPasswordForm" style="display: none;">
        <h3 style="text-align:center; margin-bottom:12px;">Qu√™n m·∫≠t kh·∫©u</h3>
        <input id="forgotEmail" type="email" placeholder="Email" />
        <button id="btnResetPassword" class="primary full">G·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u</button>
        <div class="auth-links">
          <a href="#" id="showLoginFromForgot">Quay l·∫°i ƒëƒÉng nh·∫≠p</a>
        </div>
        <div class="msg" id="forgotMsg"></div>
      </div>
    </div>
    <div id="mainSection">
      <div class="layout">
        <div class="panel panel-left">
          <h3>Nh·∫≠p gi√° tr·ªã</h3>
          <table>
            <tr><th>N·ªôi dung</th><th>Gi√° tr·ªã</th></tr>
            <tbody id="entryRows"></tbody>
          </table>
          <button id="btnSaveAll" class="primary full">L∆∞u t·∫•t c·∫£ v√† ghi log</button>
          <div class="msg" id="saveAllMsg"></div>
        </div>
        <div class="panel panel-right">
          <div class="panel-summary">
            <h3>T·ªïng l∆∞·ª£t nh·∫≠p theo ng√†y</h3>
            <div id="dailySummary"></div>
          </div>
          <div class="panel-stats">
            <h3>Th·ªëng k√™ th√°ng</h3>
            <div class="chart-container"><canvas id="statsChart"></canvas></div>
            <div id="statsOutput"></div>
            <div class="filter-controls">
              <input type="month" id="monthPicker" />
              <button id="btnLoadStats" class="primary full">T·∫£i th·ªëng k√™</button>
              <button id="btnCopyMonthly" class="success full">Copy % th√°ng</button>
            </div>
          </div>
        </div>
      </div>
      <div id="lastEntryLog" class="msg"></div>
    </div>
    <div style="padding:20px;">
      <h3>Console Log</h3>
      <div id="logConsole" class="console"></div>
    </div>
  </div>
  <script>
  // console override
  (function(){
    const c = document.getElementById('logConsole');
    const timestamp = () => {
      const now = new Date();
      return `[${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}.${now.getMilliseconds().toString().padStart(3,'0')}]`;
    };
    
    ['log', 'error', 'warn', 'info'].forEach(fn => {
      const o = console[fn];
      console[fn] = (...args) => {
        const prefix = timestamp() + ` [${fn.toUpperCase()}] `;
        o.apply(console, [prefix, ...args]);
        c.textContent += prefix + args.join(' ') + '\n';
        c.scrollTop = c.scrollHeight;
      };
    });
    
    console.auth = (...args) => console.log('üì≤ AUTH:', ...args);
    console.db = (...args) => console.log('üíæ DB:', ...args);
    console.ui = (...args) => console.log('üñ•Ô∏è UI:', ...args);
    console.process = (...args) => console.log('‚öôÔ∏è PROCESS:', ...args);
    
    console.log('=== H·ªá th·ªëng log m·ªü r·ªông ƒë√£ kh·ªüi t·∫°o ===');
    window.addEventListener('error', e => console.error(`Global Error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`));
  })();

  // Firebase
  const cfg={apiKey:'AIzaSyDsdrQakeA8iZ3iVerSNRvXC9bneyzluSU',authDomain:'ehoadon-bkav.firebaseapp.com',databaseURL:'https://ehoadon-bkav-default-rtdb.firebaseio.com',projectId:'ehoadon-bkav'};
  firebase.initializeApp(cfg);
  const auth=firebase.auth(), db=firebase.database();
  const categories=['Truy·ªÅn nh·∫≠n','TVAN','IVAN','eCT','eHD','CKS','AIBooks','eContract','eQLHƒê'];

  // H√†m l∆∞u ƒë∆°n l·∫ª
  async function saveEntry(category, val) {
    try {
      const u = auth.currentUser; 
      if(!u) {
        console.auth('Kh√¥ng t√¨m th·∫•y user ƒëƒÉng nh·∫≠p, h·ªßy thao t√°c l∆∞u');
        return;
      }
      
      console.process(`B·∫Øt ƒë·∫ßu l∆∞u d·ªØ li·ªáu cho user UID: ${u.uid}, email: ${u.email}`);
      console.process(`L∆∞u d·ªØ li·ªáu cho danh m·ª•c: ${category}, gi√° tr·ªã: ${val}`);
      
      const now = new Date();
      const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
      const mk = `${y}-${m}`, dk = `${y}-${m}-${d}`;
      
      console.db(`Kh√≥a monthly: ${mk}, kh√≥a daily: ${dk}`);
      
      // monthly
      console.db(`ƒêang truy v·∫•n d·ªØ li·ªáu th√°ng hi·ªán t·∫°i cho user: ${u.uid}, danh m·ª•c: ${category}`);
      const refM = db.ref(`users/${u.uid}/monthly/${mk}/${category}`);
      const snapM = await refM.once('value');
      const prevM = snapM.val() || 0;
      console.db(`Gi√° tr·ªã hi·ªán t·∫°i c·ªßa danh m·ª•c ${category} trong th√°ng: ${prevM}`);
      await refM.set(prevM + val);
      console.db(`ƒê√£ l∆∞u ${category}: +${val} (t·ªïng th√°ng hi·ªán t·∫°i: ${prevM+val})`);
      
      // daily summary
      console.db(`ƒêang truy v·∫•n d·ªØ li·ªáu ng√†y hi·ªán t·∫°i cho user: ${u.uid}`);
      const dRef = db.ref(`users/${u.uid}/dailySummary/${dk}`);
      const snapD = await dRef.once('value');
      const prevD = snapD.val() || 0;
      console.db(`Gi√° tr·ªã hi·ªán t·∫°i c·ªßa ng√†y ${dk}: ${prevD}`);
      await dRef.set(prevD + val);
      console.db(`ƒê√£ c·∫≠p nh·∫≠t t·ªïng ng√†y ${dk}: +${val} (t·ªïng hi·ªán t·∫°i: ${prevD+val})`);
      
      // last entry timestamp
      const ts = new Date().toLocaleString('vi-VN');
      console.db(`C·∫≠p nh·∫≠t timestamp l·∫ßn nh·∫≠p cu·ªëi: ${ts}`);
      await db.ref(`users/${u.uid}/lastEntry`).set(ts);
      console.db(`ƒê√£ l∆∞u timestamp l·∫ßn nh·∫≠p cu·ªëi`);
      
      document.getElementById('lastEntryLog').innerText = `L·∫ßn nh·∫≠p cu·ªëi: ${ts}`;
      console.ui('ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin l·∫ßn nh·∫≠p cu·ªëi tr√™n UI');
      
      console.process('ƒêang t·∫£i l·∫°i t·ªïng h·ª£p theo ng√†y');
      await loadDailySummary();
      console.process('ƒêang t·∫£i l·∫°i th·ªëng k√™');
      await loadStats();
      console.process('Ho√†n th√†nh qu√° tr√¨nh l∆∞u tr·ªØ v√† c·∫≠p nh·∫≠t');
    } catch (err) {
      console.error(`L·ªói trong saveEntry (${category}, ${val}): ${err.message}`);
    }
  }

  function buildEntryRows() {
    try {
      console.ui('ƒêang t·∫°o c√°c h√†ng nh·∫≠p li·ªáu');
      const tbody = document.getElementById('entryRows');
      if (!tbody) throw new Error('Kh√¥ng t√¨m th·∫•y entryRows element');
      tbody.innerHTML = categories.map(c => 
        `<tr><td>${c}</td><td><input id="in-${c}" type="number" min="0" /></td></tr>`
      ).join('');
      
      categories.forEach(c => {
        const inp = document.getElementById(`in-${c}`);
        if (!inp) throw new Error(`Kh√¥ng t√¨m th·∫•y input cho danh m·ª•c ${c}`);
        inp.addEventListener('keypress', async e => {
          if(e.key === 'Enter') {
            const v = parseInt(inp.value) || 0;
            if(v > 0) {
              console.ui(`Ng∆∞·ªùi d√πng nh·∫•n Enter t·∫°i danh m·ª•c ${c} v·ªõi gi√° tr·ªã ${v}`);
              await saveEntry(c, v);
            } else {
              console.ui(`B·ªè qua v√¨ gi√° tr·ªã kh√¥ng h·ª£p l·ªá: ${inp.value}`);
            }
            inp.value = '';
          }
        });
      });
      console.ui('ƒê√£ ho√†n th√†nh thi·∫øt l·∫≠p c√°c h√†ng nh·∫≠p li·ªáu v√† s·ª± ki·ªán');
    } catch (err) {
      console.error(`L·ªói trong buildEntryRows: ${err.message}`);
    }
  }

  function getCurrentMonth() {
    const d = new Date(), y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  auth.onAuthStateChanged(async user => {
    try {
      if(user) {
        console.auth(`User ƒëƒÉng nh·∫≠p th√†nh c√¥ng - UID: ${user.uid}, Email: ${user.email}`);
        const w = document.getElementById('welcomeMsg'), lo = document.getElementById('btnLogout');
        const au = document.getElementById('authSection'), ma = document.getElementById('mainSection');
        
        if (!w || !lo || !au || !ma) throw new Error('Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ UI c·∫ßn thi·∫øt');
        
        lo.style.display = 'inline-block';
        au.style.display = 'none';
        ma.style.display = 'block';
        w.innerText = `Ch√†o b·∫°n: ${user.email}`;
        console.ui('ƒê√£ chuy·ªÉn sang giao di·ªán ƒë√£ ƒëƒÉng nh·∫≠p');
        
        buildEntryRows();
        const monthPicker = document.getElementById('monthPicker');
        if (!monthPicker) throw new Error('Kh√¥ng t√¨m th·∫•y monthPicker element');
        monthPicker.value = getCurrentMonth();
        console.ui(`ƒê√£ thi·∫øt l·∫≠p th√°ng hi·ªán t·∫°i: ${getCurrentMonth()}`);
        
        console.process('ƒêang t·∫£i th√¥ng tin l·∫ßn nh·∫≠p cu·ªëi');
        await loadLastEntry(user.uid);
        
        console.process('ƒêang t·∫£i t·ªïng h·ª£p theo ng√†y');
        await loadDailySummary();
        
        console.process('ƒêang t·∫£i th·ªëng k√™');
        await loadStats();
        
        console.process('Kh·ªüi t·∫°o ho√†n t·∫•t cho ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p');
      } else {
        console.auth('Kh√¥ng c√≥ user ƒëƒÉng nh·∫≠p');
        const lo = document.getElementById('btnLogout'), w = document.getElementById('welcomeMsg');
        const au = document.getElementById('authSection'), ma = document.getElementById('mainSection');
        
        if (!lo || !w || !au || !ma) throw new Error('Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ UI c·∫ßn thi·∫øt');
        
        lo.style.display = 'none';
        w.innerText = '';
        au.style.display = 'block';
        ma.style.display = 'none';
        console.ui('ƒê√£ chuy·ªÉn sang giao di·ªán ƒëƒÉng nh·∫≠p');
      }
    } catch (err) {
      console.error(`L·ªói trong onAuthStateChanged: ${err.message}`);
    }
  });

  // Login
  document.getElementById('btnLogin').onclick = async () => {
    try {
      const e = document.getElementById('email').value;
      const p = document.getElementById('password').value;
      console.auth(`ƒêang th·ª≠ ƒëƒÉng nh·∫≠p v·ªõi email: ${e}`);
      
      if (!e || !p) throw new Error('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
      
      console.auth('G·ª≠i y√™u c·∫ßu x√°c th·ª±c ƒë·∫øn Firebase');
      await auth.signInWithEmailAndPassword(e, p);
      localStorage.setItem('lastLoginDate', new Date().toISOString().slice(0, 10));
      console.auth(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi email: ${e}`);
    } catch(err) {
      console.error(`L·ªói ƒëƒÉng nh·∫≠p: ${err.message}`);
      const authMsg = document.getElementById('authMsg');
      if (authMsg) authMsg.innerText = err.message;
      console.ui('Hi·ªÉn th·ªã th√¥ng b√°o l·ªói ƒëƒÉng nh·∫≠p tr√™n UI');
    }
  };

  // Register
  document.getElementById('btnRegister').onclick = async () => {
    try {
      const e = document.getElementById('regEmail').value;
      const p = document.getElementById('regPassword').value;
      const cp = document.getElementById('regConfirmPassword').value;
      const msg = document.getElementById('registerMsg');
      
      if (!e || !p || !cp) throw new Error('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
      if (p !== cp) throw new Error('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
      
      console.auth(`Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i: ${e}`);
      const signInMethods = await auth.fetchSignInMethodsForEmail(e);
      if (signInMethods.length > 0) {
        throw new Error('Email n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω. Vui l√≤ng s·ª≠ d·ª•ng email kh√°c ho·∫∑c ƒëƒÉng nh·∫≠p.');
      }
      
      console.auth(`ƒêang th·ª≠ ƒëƒÉng k√Ω v·ªõi email: ${e}`);
      console.auth('G·ª≠i y√™u c·∫ßu ƒëƒÉng k√Ω ƒë·∫øn Firebase');
      await auth.createUserWithEmailAndPassword(e, p);
      console.auth(`ƒêƒÉng k√Ω th√†nh c√¥ng v·ªõi email: ${e}`);
      msg.innerText = 'ƒêƒÉng k√Ω th√†nh c√¥ng! ƒêang chuy·ªÉn v·ªÅ ƒëƒÉng nh·∫≠p...';
      setTimeout(() => {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        msg.innerText = '';
      }, 2000);
    } catch(err) {
      console.error(`L·ªói ƒëƒÉng k√Ω: ${err.message}`);
      const msg = document.getElementById('registerMsg');
      if (msg) msg.innerText = err.message;
      console.ui('Hi·ªÉn th·ªã th√¥ng b√°o l·ªói ƒëƒÉng k√Ω tr√™n UI');
    }
  };

  // Forgot Password
  document.getElementById('btnResetPassword').onclick = async () => {
    try {
      const e = document.getElementById('forgotEmail').value;
      const msg = document.getElementById('forgotMsg');
      
      if (!e) throw new Error('Vui l√≤ng nh·∫≠p email');
      
      console.auth(`Ki·ªÉm tra email t·ªìn t·∫°i: ${e}`);
      const signInMethods = await auth.fetchSignInMethodsForEmail(e);
      if (signInMethods.length === 0) {
        throw new Error('Email n√†y ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω. Vui l√≤ng ki·ªÉm tra l·∫°i ho·∫∑c ƒëƒÉng k√Ω t√†i kho·∫£n m·ªõi.');
      }
      
      console.auth(`ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho email: ${e}`);
      console.auth('G·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u qua Firebase');
      await auth.sendPasswordResetEmail(e);
      console.auth(`ƒê√£ g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u cho: ${e}`);
      msg.innerText = 'Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i! Ki·ªÉm tra h·ªôp th∆∞ c·ªßa b·∫°n.';
      setTimeout(() => {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('forgotPasswordForm').style.display = 'none';
        msg.innerText = '';
      }, 3000);
    } catch(err) {
      console.error(`L·ªói g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u: ${err.message}`);
      const msg = document.getElementById('forgotMsg');
      if (msg) msg.innerText = err.message;
      console.ui('Hi·ªÉn th·ªã th√¥ng b√°o l·ªói g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u tr√™n UI');
    }
  };

  // Form switching
  document.getElementById('showRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    console.ui('Chuy·ªÉn sang giao di·ªán ƒëƒÉng k√Ω');
  };

  document.getElementById('showForgotPassword').onclick = () => {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'block';
    console.ui('Chuy·ªÉn sang giao di·ªán qu√™n m·∫≠t kh·∫©u');
  };

  document.getElementById('showLoginFromRegister').onclick = () => {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    console.ui('Chuy·ªÉn v·ªÅ giao di·ªán ƒëƒÉng nh·∫≠p t·ª´ ƒëƒÉng k√Ω');
  };

  document.getElementById('showLoginFromForgot').onclick = () => {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('forgotPasswordForm').style.display = 'none';
    console.ui('Chuy·ªÉn v·ªÅ giao di·ªán ƒëƒÉng nh·∫≠p t·ª´ qu√™n m·∫≠t kh·∫©u');
  };

  // Logout
  document.getElementById('btnLogout').onclick = async () => {
    try {
      console.auth('ƒêang th·ª±c hi·ªán ƒëƒÉng xu·∫•t');
      await auth.signOut();
      localStorage.removeItem('lastLoginDate');
      console.auth('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng');
    } catch (err) {
      console.error(`L·ªói ƒëƒÉng xu·∫•t: ${err.message}`);
    }
  };

  async function loadLastEntry(uid) {
    try {
      console.db(`ƒêang t·∫£i th√¥ng tin l·∫ßn nh·∫≠p cu·ªëi c·ªßa user UID: ${uid}`);
      const snap = await db.ref(`users/${uid}/lastEntry`).once('value');
      const ts = snap.val();
      console.db(`L·∫ßn nh·∫≠p cu·ªëi: ${ts || 'ch∆∞a c√≥'}`);
      
      const lastEntryLog = document.getElementById('lastEntryLog');
      if (!lastEntryLog) throw new Error('Kh√¥ng t√¨m th·∫•y lastEntryLog element');
      lastEntryLog.innerText = ts ? `L·∫ßn nh·∫≠p cu·ªëi: ${ts}` : '';
      console.ui('ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin l·∫ßn nh·∫≠p cu·ªëi tr√™n UI');
    } catch (err) {
      console.error(`L·ªói trong loadLastEntry: ${err.message}`);
    }
  }

  async function loadDailySummary() {
    try {
      console.process('B·∫Øt ƒë·∫ßu t·∫£i t·ªïng h·ª£p theo ng√†y');
      
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const today = `${y}-${m}-${d}`;
      console.db(`Ng√†y hi·ªán t·∫°i: ${today}`);

      if (!auth.currentUser) throw new Error('Kh√¥ng c√≥ user ƒëƒÉng nh·∫≠p');
      console.db(`ƒêang truy v·∫•n d·ªØ li·ªáu dailySummary cho user: ${auth.currentUser.uid}`);
      const snap = await db.ref(`users/${auth.currentUser.uid}/dailySummary`).once('value');
      const obj = snap.val() || {};
      console.db(`Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu dailySummary:`, obj);

      let h = '<table><tr><th>Ng√†y</th><th>T·ªïng</th></tr>';
      
      if (obj[today]) {
        console.db(`C√≥ d·ªØ li·ªáu cho ng√†y h√¥m nay: ${obj[today]}`);
        h += `<tr><td>${today}</td><td>${obj[today]}</td></tr>`;
      } else {
        console.db('Kh√¥ng c√≥ d·ªØ li·ªáu cho ng√†y h√¥m nay, hi·ªÉn th·ªã 0');
        h += `<tr><td>${today}</td><td>0</td></tr>`;
      }
      
      h += '</table>';
      const dailySummary = document.getElementById('dailySummary');
      if (!dailySummary) throw new Error('Kh√¥ng t√¨m th·∫•y dailySummary element');
      dailySummary.innerHTML = h;
      console.ui('ƒê√£ c·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p theo ng√†y tr√™n UI');
    } catch (err) {
      console.error(`L·ªói trong loadDailySummary: ${err.message}`);
    }
  }

  document.getElementById('btnSaveAll').onclick = async () => {
    try {
      console.process('ƒêang th·ª±c hi·ªán l∆∞u t·∫•t c·∫£ c√°c m·ª•c nh·∫≠p');
      let total = 0;
      
      for(const c of categories) {
        const inp = document.getElementById(`in-${c}`);
        if (!inp) throw new Error(`Kh√¥ng t√¨m th·∫•y input cho danh m·ª•c ${c}`);
        const v = parseInt(inp.value) || 0;
        
        if(v > 0) {
          console.process(`ƒêang l∆∞u danh m·ª•c ${c} v·ªõi gi√° tr·ªã ${v}`);
          await saveEntry(c, v);
          total += v;
        }
        inp.value = '';
      }
      
      const msg = total > 0 ? 'L∆∞u xong!' : 'Ch∆∞a nh·∫≠p gi√° tr·ªã.';
      const saveAllMsg = document.getElementById('saveAllMsg');
      if (!saveAllMsg) throw new Error('Kh√¥ng t√¨m th·∫•y saveAllMsg element');
      saveAllMsg.innerText = msg;
      console.ui(`Hi·ªÉn th·ªã th√¥ng b√°o: ${msg}`);
      
      setTimeout(() => {
        saveAllMsg.innerText = '';
        console.ui('ƒê√£ x√≥a th√¥ng b√°o');
      }, 2000);
      
      console.process(`Ho√†n th√†nh l∆∞u t·∫•t c·∫£ v·ªõi t·ªïng s·ªë: ${total}`);
    } catch (err) {
      console.error(`L·ªói trong btnSaveAll: ${err.message}`);
    }
  };

  let chart;
  function initChart(){ 
    try {
      const canvas = document.getElementById('statsChart');
      if (!canvas) throw new Error('Kh√¥ng t√¨m th·∫•y statsChart element');
      const c = canvas.getContext('2d'); 
      chart = new Chart(c, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [{
            label: 'Gi√° tr·ªã',
            data: [],
            backgroundColor: '#3498db'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      }); 
      console.ui('Bi·ªÉu ƒë·ªì ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o'); 
    } catch (err) {
      console.error(`L·ªói trong initChart: ${err.message}`);
    }
  }

  async function loadStats() {
    try {
      const mk = document.getElementById('monthPicker').value;
      console.process(`B·∫Øt ƒë·∫ßu t·∫£i th·ªëng k√™ cho th√°ng: ${mk}`);
      
      if (!auth.currentUser) throw new Error('Kh√¥ng c√≥ user ƒëƒÉng nh·∫≠p');
      console.db(`ƒêang truy v·∫•n d·ªØ li·ªáu monthly cho user: ${auth.currentUser.uid}, th√°ng: ${mk}`);
      const snap = await db.ref(`users/${auth.currentUser.uid}/monthly/${mk}`).once('value');
      const obj = snap.val() || {};
      console.db(`Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu th·ªëng k√™ th√¥:`, obj);
      
      const raw = categories.map(n => ({name: n, value: obj[n] || 0}));
      const tot = raw.reduce((s, r) => s + r.value, 0);
      console.process(`T·ªïng gi√° tr·ªã c·ªßa t·∫•t c·∫£ danh m·ª•c: ${tot}`);
      
      let list = raw.map(r => ({
        name: r.name, 
        value: r.value, 
        pct: tot > 0 ? Math.round(r.value / tot * 10000) / 100 : 0
      }));
      
      if(tot > 0) {
        const mi = list.reduce((i, c, j, a) => c.pct > a[i].pct ? j : i, 0);
        const sum = list.reduce((s, i) => s + i.pct, 0);
        const d = Math.round((100 - sum) * 100) / 100;
        list[mi].pct += d;
        console.process(`ƒêi·ªÅu ch·ªânh ph·∫ßn trƒÉm cho danh m·ª•c ${list[mi].name}: +${d}% (t·ªïng m·ªõi: ${list[mi].pct}%)`);
      }
      
      console.db('D·ªØ li·ªáu th·ªëng k√™ ƒë√£ x·ª≠ l√Ω:', list);
      
      const vals = list.map(i => i.value);
      
      if(!chart) {
        console.ui('Kh·ªüi t·∫°o bi·ªÉu ƒë·ªì');
        initChart();
      }
      
      chart.data.datasets[0].data = vals;
      chart.update();
      console.ui('ƒê√£ c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì');
      
      const sorted = [...list].sort((a, b) => b.pct - a.pct);
      let h = '<h4>Th·ªëng k√™ Gi√° tr·ªã</h4><table><tr><th>#</th><th>N·ªôi dung</th><th>Gi√° tr·ªã</th><th>T·ª∑ l·ªá %</th></tr>';
      
      sorted.forEach((i, j) => h += `<tr><td>${j+1}</td><td>${i.name}</td><td>${i.value}</td><td>${i.pct.toFixed(2)}%</td></tr>`);
      
      h += `<tr style="font-weight: bold; background-color: #f2f2f2;"><td colspan="2">T·ªîNG C·ªòNG</td><td>${tot}</td><td>100.00%</td></tr>`;
      
      h += '</table>';
      
      const statsOutput = document.getElementById('statsOutput');
      if (!statsOutput) throw new Error('Kh√¥ng t√¨m th·∫•y statsOutput element');
      statsOutput.innerHTML = h;
      console.ui('ƒê√£ c·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ tr√™n UI v·ªõi d√≤ng t·ªïng c·ªông');
      
      window.pctOriginalCopy = list;
      console.process('Ho√†n th√†nh t·∫£i th·ªëng k√™');
    } catch (err) {
      console.error(`L·ªói trong loadStats: ${err.message}`);
    }
  }

  document.getElementById('btnLoadStats').onclick = loadStats;
  document.getElementById('btnCopyMonthly').onclick = () => {
    try {
      const arr = window.pctOriginalCopy || []; 
      if(!arr.length) {
        console.ui('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ ƒë·ªÉ sao ch√©p');
        return alert('Ch∆∞a c√≥ th·ªëng k√™');
      }
      const lines = arr.map((i, j) => `${j+1}. ${i.name}: ${i.pct.toFixed(2)}%`);
      navigator.clipboard.writeText(lines.join('\n')).then(() => {
        console.ui('ƒê√£ sao ch√©p ph·∫ßn trƒÉm th·ªëng k√™ v√†o clipboard');
      });
    } catch (err) {
      console.error(`L·ªói trong btnCopyMonthly: ${err.message}`);
    }
  };
  </script>
