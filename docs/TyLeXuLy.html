<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªëng k√™ D·ªØ li·ªáu</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
      background-color: #f4f4f4;
    }
    /* Giao di·ªán ban ƒë·∫ßu */
    #defaultInterface { 
      display: flex;  
      flex-wrap: wrap;
      gap: 20px;
      align-items: stretch;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: white;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    .input-section, .chart-section { 
      flex: 1;
      min-width: 300px;
    }
    .input-section h3, .chart-section h3 { 
      color: #333;
    }
    table { 
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td { 
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th { 
      background: #f8f8f8;
    }
    input[type="text"], input[type="month"] { 
      padding: 5px; 
      border: 1px solid #ccc; 
      border-radius: 5px; 
      text-align: center;
    }
    button { 
      padding: 10px 15px;
      border: none;
      background: red;
      color: white;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
    }
    button:hover { 
      background: darkred;
    }
    canvas { 
      max-width: 100%;
      background: white;
    }
    /* C√°c n√∫t ch·ª©c nƒÉng */
    #copyData, .filter-button, .search-button { 
      margin-top: 10px;
      padding: 10px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      display: inline-block;
    }
    #copyData:hover, .filter-button:hover, .search-button:hover, .search:hover{ 
      background: #27ae60;
    }
    #output-container { 
      text-align: center;
      margin-top: 10px;
      background: #ecf0f1;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #bdc3c7;
      display: none;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      font-size: 0.85em;
    }
    #output { 
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .copied-message { 
      color: green;
      font-weight: bold;
      margin-top: 5px;
      display: none;
    }
    /* Th√¥ng b√°o ghi nh·∫≠n k·∫øt qu·∫£ */
    #recordMessage {
      color: green;
      font-weight: bold;
      margin-top: 5px;
      display: none;
    }
    #totalEntries, #dailyEntries { 
      font-weight: bold;
      margin-top: 10px;
      color: #2c3e50;
    }
    #lastUpdated { 
      font-size: 14px;
      color: #555;
      margin-top: 10px;
    }
    /* Giao di·ªán t√¨m ki·∫øm ‚Äì ·∫©n m·∫∑c ƒë·ªãnh */
    #searchInterface { 
      display: none;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: #f9f9f9;
      border: 2px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    #searchInterface div { 
      margin-bottom: 10px;
    }
    #noDataMessage { 
      color: red;
      font-weight: bold;
      margin-top: 10px;
      display: none;
    }
    .search{
      background: #2ecc71;
    }
    /* Dropdown l·ªçc theo Th√°ng-NƒÉm */
    #filterContainer {
      margin-top: 10px;
    }
    #filterMonth {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: center;
    }
    /* Modal x√°c nh·∫≠n m·∫≠t kh·∫©u */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 300px; 
      text-align: center;
      border-radius: 5px;
    }
    /* Loading Overlay */
    #loadingOverlay {
      display: none;
      position: fixed;
      z-index: 200;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
        footer {
      max-width: 900px;
      margin: 30px auto;
      padding: 15px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0px 0px 8px rgba(0,0,0,0.1);
      text-align: left;
      color: #333;
    }
    footer h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }
    footer ul {
      list-style: disc inside;
      margin: 0;
      padding-left: 20px;
    }
    footer em {
      color: #555;
    }
  </style>
</head>
<body>
  <h2>Th·ªëng k√™ D·ªØ li·ªáu</h2>
  <!-- Giao di·ªán ban ƒë·∫ßu -->
  <div id="defaultInterface">
    <div class="input-section">
      <h3>Nh·∫≠p d·ªØ li·ªáu</h3>
      <table>
        <tr>
          <th>N·ªôi dung</th>
          <th>Gi√° tr·ªã</th>
        </tr>
        <tbody id="inputs"></tbody>
      </table>
      <div id="totalEntries">T·ªïng s·ªë l·∫ßn nh·∫≠p: 0</div>
      <!-- Hi·ªÉn th·ªã s·ªë k·∫øt qu·∫£ trong ng√†y -->
      <div id="dailyEntries">T·ªïng s·ªë k·∫øt qu·∫£ h√¥m nay: 0</div>
      <!-- Hi·ªÉn th·ªã "L·∫ßn c·∫≠p nh·∫≠t cu·ªëi" -->
      <div id="lastUpdated">L·∫ßn c·∫≠p nh·∫≠t cu·ªëi: Ch∆∞a c√≥</div>
      
      <!-- Dropdown l·ªçc theo Th√°ng-NƒÉm v√† n√∫t L·ªçc -->
      <div id="filterContainer">
        <select id="filterMonth">
          <option value="">--Ch·ªçn Th√°ng-NƒÉm--</option>
        </select>
        <button class="filter-button" onclick="filterDataByMonth()">L·ªçc</button>
      </div>
      
      <!-- N√∫t Clear Cache thay v√¨ g·ªçi tr·ª±c ti·∫øp clearData() s·∫Ω g·ªçi showPasswordModal() -->
      <button onclick="showPasswordModal()">Clear Cache</button>
      <button id="copyData" onclick="copyValues()">Copy Gi√° tr·ªã</button>
      <!-- N√∫t chuy·ªÉn sang giao di·ªán t√¨m ki·∫øm n√¢ng cao -->
      <button class="search" onclick="showSearchInterface()">T√¨m ki·∫øm n√¢ng cao</button>
      <!-- <button class="logout" onclick="logout()">ƒêƒÉng xu·∫•t</button> -->
      <div class="copied-message" id="copiedMessage">ƒê√£ copy th√†nh c√¥ng!</div>
      <div class="copied-message" id="summaryMessage" style="display: none;">ƒê√£ th·ªëng k√™ k·∫øt qu·∫£ th√†nh c√¥ng!</div>
      <!-- Th√¥ng b√°o ghi nh·∫≠n k·∫øt qu·∫£ -->
      <div class="copied-message" id="recordMessage" style="display: none;">Ghi nh·∫≠n k·∫øt qu·∫£ th√†nh c√¥ng!</div>
    </div>
    <div class="chart-section">
      <canvas id="barChart"></canvas>
      <div id="output-container">
        <h3>K·∫øt qu·∫£</h3>
        <div id="output"></div>
      </div>
    </div>
  </div>
  
  <!-- Giao di·ªán t√¨m ki·∫øm theo kho·∫£ng th·ªùi gian -->
  <div id="searchInterface">
    <h3>T√¨m ki·∫øm theo kho·∫£ng th·ªùi gian</h3>
    <div>
      <label for="fromMonth">T·ª´ th√°ng:</label>
      <input type="month" id="fromMonth">
      <label for="toMonth">ƒê·∫øn th√°ng:</label>
      <input type="month" id="toMonth">
    </div>
    <div>
      <button class="search-button" onclick="searchData()">T√¨m ki·∫øm</button>
      <button class="search-button" onclick="backToDefault()">Quay l·∫°i</button>
      <!-- N√∫t copy k·∫øt qu·∫£ t√¨m ki·∫øm -->
      <button class="search-button" onclick="copySearchResults()">Copy K·∫øt qu·∫£</button>
      <div class="copied-message" id="copiedMessageSearch" style="display:none;">ƒê√£ copy k·∫øt qu·∫£ t√¨m ki·∫øm!</div>
    </div>
    <div id="noDataMessage">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu t∆∞∆°ng ·ª©ng!</div>
    <div id="searchResultContainer" style="display: none;">
      <h3>K·∫øt qu·∫£ t√¨m ki·∫øm</h3>
      <div id="searchResult"></div>
    </div>
  </div>
  
  <!-- Modal x√°c nh·∫≠n m·∫≠t kh·∫©u -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3>X√°c nh·∫≠n m·∫≠t kh·∫©u</h3>
      <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
      <div style="margin-top: 10px;">
        <button onclick="confirmClearCache()">X√°c nh·∫≠n</button>
        <button onclick="hidePasswordModal()">H·ªßy</button>
      </div>
      <div id="passwordCorrect" style="color: seagreen; display: none; margin-top: 10px;">X√°c nh·∫≠n th√†nh c√¥ng</div>
      <div id="passwordError" style="color: red; display: none; margin-top: 10px;">M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!</div>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
  </div>
    <!-- Footer h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng -->
  <footer>
    <h3>üìò H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng c√¥ng c·ª•</h3>
    <ul>
      <li>Nh·∫≠p gi√° tr·ªã v√†o c√°c √¥ t∆∞∆°ng ·ª©ng v·ªõi danh m·ª•c: <strong>Truy·ªÅn nh·∫≠n</strong>, <strong>TVAN</strong>, <strong>IVAN</strong>, v.v.</li>
      <li>Nh·∫•n <strong>Enter</strong> ƒë·ªÉ ghi nh·∫≠n gi√° tr·ªã, t·ª± ƒë·ªông c·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì v√† b·∫£ng th·ªëng k√™.</li>
      <li>Xem <em>T·ªïng s·ªë l·∫ßn nh·∫≠p</em> v√† <em>T·ªïng s·ªë k·∫øt qu·∫£ h√¥m nay</em> ·ªü b√™n d∆∞·ªõi danh s√°ch.</li>
      <li>S·ª≠ d·ª•ng dropdown <strong>Ch·ªçn Th√°ng-NƒÉm</strong> r·ªìi nh·∫•n <strong>L·ªçc</strong> ƒë·ªÉ xem d·ªØ li·ªáu theo th√°ng.</li>
      <li>Nh·∫•n <strong>Copy Gi√° tr·ªã</strong> ƒë·ªÉ sao ch√©p t·ªâ l·ªá ph·∫ßn trƒÉm c√°c m·ª•c ƒë√£ nh·∫≠p.</li>
      <li>Chuy·ªÉn sang <strong>T√¨m ki·∫øm n√¢ng cao</strong> ƒë·ªÉ t·ªïng h·ª£p v√† xem k·∫øt qu·∫£ trong kho·∫£ng th·ªùi gian c·ª• th·ªÉ.</li>
      <li>Nh·∫•n <strong>Clear Cache</strong> ƒë·ªÉ x√≥a d·ªØ li·ªáu th√°ng hi·ªán t·∫°i (c√≥ y√™u c·∫ßu m·∫≠t kh·∫©u).</li>
      <li>K·∫øt qu·∫£ t√¨m ki·∫øm v√† sao ch√©p h·ªó tr·ª£ ghi nh·∫≠n &nbsp;gi√° tr·ªã &amp; t·ªâ l·ªá ph·∫ßn trƒÉm t·ª± ƒë·ªông.</li>
    </ul>
    <p><em>Ghi ch√∫:</em> To√†n b·ªô d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô trong <code>localStorage</code>, kh√¥ng g·ª≠i l√™n server. ƒê·∫£m b·∫£o s·ª≠ d·ª•ng c√πng tr√¨nh duy·ªát ƒë·ªÉ truy xu·∫•t d·ªØ li·ªáu.</p>
  </footer>
  
  <script>
    // C√°c bi·∫øn v√† h√†m to√†n c·ª•c
    const categories = ["Truy·ªÅn nh·∫≠n", "TVAN", "IVAN", "eCT", "eHD", "CKS", "AIBooks", "eContract", "eQLHƒê"];
    let data = {};
    let dailyData = {};
    let lastUpdated = "Ch∆∞a c√≥";
    const defaultMonth = (new Date()).getFullYear() + "-" + ("0" + ((new Date()).getMonth() + 1)).slice(-2);
    
    categories.forEach(cat => {
      data[cat] = 0;
      dailyData[cat] = 0;
    });
    
    // -------------------------
    // C√°c h√†m ti·ªán √≠ch
    // -------------------------
    function getCurrentMonthKey() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      return `data-${year}-${month}`;
    }
    function getLastUpdatedKey() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;
      return `lastUpdated-${year}-${month}`;
    }
    function getCurrentDayKey() {
      const now = new Date();
      const year = now.getFullYear();
      const month = ("0" + (now.getMonth() + 1)).slice(-2);
      const day = ("0" + now.getDate()).slice(-2);
      return `dailyData-${year}-${month}-${day}`;
    }
    function clearOldDailyData() {
      const todayKey = getCurrentDayKey();
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key.startsWith("dailyData-") && key !== todayKey) {
          localStorage.removeItem(key);
        }
      }
    }
    clearOldDailyData();
    
    // -------------------------
    // T·∫°o form nh·∫≠p li·ªáu
    // -------------------------
    function createInputFields() {
      const container = document.getElementById("inputs");
      container.innerHTML = categories.map(cat => 
        `<tr>
           <td>${cat}</td>
           <td><input type='text' id='${cat}' onkeydown='handleKeyPress(event, "${cat}")'></td>
         </tr>`
      ).join("\n");
    }
    
    // -------------------------
    // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì (Chart)
    // -------------------------
    function updateChart() {
      if (window.chart) {
        window.chart.data.datasets[0].data = categories.map(cat => data[cat]);
        window.chart.update();
      }
      updateTotalEntries();
    }
    
    // -------------------------
    // Load d·ªØ li·ªáu c·ªßa th√°ng c·ª• th·ªÉ
    // -------------------------
    function loadDataForMonth(monthStr) {
      const parts = monthStr.split("-");
      const year = parts[0];
      const month = parseInt(parts[1], 10);
      const key = `data-${year}-${month}`;
      let stored = localStorage.getItem(key);
      try {
        data = stored ? JSON.parse(stored) : {};
      } catch(e) {
        console.error("L·ªói khi parse d·ªØ li·ªáu cho key " + key, e);
        data = {};
      }
      const lastKey = `lastUpdated-${year}-${month}`;
      lastUpdated = localStorage.getItem(lastKey) || "Ch∆∞a c√≥";
      document.getElementById("lastUpdated").innerText = `L·∫ßn c·∫≠p nh·∫≠t cu·ªëi: ${lastUpdated}`;
      categories.forEach(cat => { if (!(cat in data)) data[cat] = 0; });
      updateChart();
      updateTotalEntries();
      createInputFields();
      summarizeValues();
    }
    
    // -------------------------
    // Load d·ªØ li·ªáu trong ng√†y
    // -------------------------
    function loadDailyData() {
      const key = getCurrentDayKey();
      let stored = localStorage.getItem(key);
      try {
        dailyData = stored ? JSON.parse(stored) : {};
      } catch(e) {
        console.error("L·ªói khi parse d·ªØ li·ªáu cho key " + key, e);
        dailyData = {};
      }
      categories.forEach(cat => { if (!(cat in dailyData)) dailyData[cat] = 0; });
      updateDailyEntries();
    }
    
    // -------------------------
    // C·∫≠p nh·∫≠t t·ªïng s·ªë l·∫ßn nh·∫≠p theo th√°ng
    // -------------------------
    function updateTotalEntries() {
      let total = Object.values(data).reduce((acc, val) => acc + val, 0);
      document.getElementById("totalEntries").innerText = `T·ªïng s·ªë l·∫ßn nh·∫≠p: ${total}`;
    }
    
    // -------------------------
    // C·∫≠p nh·∫≠t t·ªïng s·ªë k·∫øt qu·∫£ trong ng√†y
    // -------------------------
    function updateDailyEntries() {
      let dailyTotal = Object.values(dailyData).reduce((acc, val) => acc + val, 0);
      document.getElementById("dailyEntries").innerText = `T·ªïng s·ªë k·∫øt qu·∫£ h√¥m nay: ${dailyTotal}`;
    }
    
    // -------------------------
    // L∆∞u d·ªØ li·ªáu v√†o Local Storage (theo th√°ng)
    // -------------------------
    function saveData() {
      const key = getCurrentMonthKey();
      localStorage.setItem(key, JSON.stringify(data));
      updateLastUpdated();
      updateTotalEntries();
    }
    
    // -------------------------
    // L∆∞u d·ªØ li·ªáu trong ng√†y v√†o Local Storage
    // -------------------------
    function saveDailyData() {
      const key = getCurrentDayKey();
      localStorage.setItem(key, JSON.stringify(dailyData));
      updateDailyEntries();
    }
    
    // -------------------------
    // X√≥a d·ªØ li·ªáu (ƒë∆∞·ª£c g·ªçi khi x√°c nh·∫≠n m·∫≠t kh·∫©u th√†nh c√¥ng)
    // -------------------------
    function clearData() {
      const key = getCurrentMonthKey();
      const lastKey = getLastUpdatedKey();
      const dailyKey = getCurrentDayKey();
      localStorage.removeItem(key);
      localStorage.removeItem(lastKey);
      localStorage.removeItem(dailyKey); // X√≥a d·ªØ li·ªáu theo ng√†y
      
      // Reset l·∫°i c√°c bi·∫øn d·ªØ li·ªáu
      data = {};
      categories.forEach(cat => data[cat] = 0);
      dailyData = {};
      categories.forEach(cat => dailyData[cat] = 0);
      
      // X√≥a d·ªØ li·ªáu trong c√°c √¥ input
      document.querySelectorAll("input[type='text']").forEach(input => input.value = "");
      
      // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
      document.getElementById("lastUpdated").innerText = "L·∫ßn c·∫≠p nh·∫≠t cu·ªëi: Ch∆∞a c√≥";
      updateChart();
      updateTotalEntries();
      updateDailyEntries();
      summarizeValues();
    }
    
    // -------------------------
    // Modal x√°c nh·∫≠n m·∫≠t kh·∫©u
    // -------------------------
    function showPasswordModal() {
      document.getElementById('passwordModal').style.display = 'block';
    }
    function hidePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordInput').value = '';
      // ·∫®n th√¥ng b√°o sau khi ƒë√≥ng modal
      document.getElementById('passwordCorrect').style.display = 'none';
      document.getElementById('passwordError').style.display = 'none';
    }
    // Hi·ªÉn th·ªã overlay loading
    function showLoadingOverlay() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }
    function hideLoadingOverlay() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }
    // Khi m·∫≠t kh·∫©u ƒë√∫ng s·∫Ω hi·ªÉn th·ªã "X√°c nh·∫≠n th√†nh c√¥ng", sau ƒë√≥ form loading, r·ªìi x√≥a cache
    function confirmClearCache() {
      const correctPassword = "admin"; // thay ƒë·ªïi m·∫≠t kh·∫©u n·∫øu c·∫ßn
      const inputPassword = document.getElementById('passwordInput').value;
      if (inputPassword === correctPassword) {
        // Hi·ªÉn th·ªã th√¥ng b√°o x√°c nh·∫≠n th√†nh c√¥ng
        document.getElementById('passwordCorrect').style.display = 'block';
        document.getElementById('passwordError').style.display = 'none';
        // Sau 1 gi√¢y, chuy·ªÉn sang loading overlay
        setTimeout(function() {
          hidePasswordModal(); // ·∫©n modal x√°c nh·∫≠n m·∫≠t kh·∫©u
          showLoadingOverlay(); // hi·ªÉn th·ªã loading
          // Sau 2 gi√¢y loading, g·ªçi h√†m clearData()
          setTimeout(function() {
            hideLoadingOverlay();
            clearData();
          }, 1000);
        }, 1000);
      } else {
        document.getElementById('passwordError').style.display = 'block';
      }
    }
    
    // -------------------------
    // H√†m th·ªëng k√™ k·∫øt qu·∫£ t·ª± ƒë·ªông (hi·ªÉn th·ªã b·∫£ng k·∫øt qu·∫£)
    // -------------------------
    function summarizeValues() {
      let total = Object.values(data).reduce((acc, val) => acc + val, 0);
      if (total === 0) {
        document.getElementById("output").innerHTML = "<p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>";
        document.getElementById("output-container").style.display = "block";
        return;
      }
      let sortedData = Object.entries(data)
        .map(([key, value]) => [key, value, (value / total * 100)])
        .sort((a, b) => b[2] - a[2]);
      sortedData.forEach(item => item[2] = Math.round(item[2] * 100) / 100);
      let totalPercentage = sortedData.reduce((acc, item) => acc + item[2], 0);
      let diff = 100 - totalPercentage;
      if (sortedData.length > 0) {
        sortedData[0][2] += diff;
      }
      let outputHTML = sortedData.map((item, index) =>
        `<tr>
           <td>${index + 1}</td>
           <td>${item[0]}</td>
           <td>${item[1]}</td>
           <td>${item[2].toFixed(2)}%</td>
         </tr>`
      ).join("");
      document.getElementById("output").innerHTML = `
        <table>
          <tr>
            <th>Rank</th>
            <th>N·ªôi dung</th>
            <th>Gi√° tr·ªã</th>
            <th>T·ª∑ l·ªá (%)</th>
          </tr>
          ${outputHTML}
        </table>
      `;
      document.getElementById("output-container").style.display = "block";
    }
    
    // -------------------------
    // X·ª≠ l√Ω khi nh·∫•n Enter trong √¥ nh·∫≠p li·ªáu
    // -------------------------
    function handleKeyPress(event, category) {
      if (event.key === "Enter") {
        const value = parseInt(event.target.value);
        if (!isNaN(value) && value > 0) {
          data[category] += value;
          dailyData[category] += value;
          event.target.value = "";
          saveData();
          saveDailyData();
          updateChart();
          summarizeValues();
          document.getElementById("recordMessage").style.display = "block";
          setTimeout(() => {
            document.getElementById("recordMessage").style.display = "none";
          }, 2000);
        } else {
          alert("Vui l√≤ng nh·∫≠p m·ªôt s·ªë nguy√™n d∆∞∆°ng h·ª£p l·ªá.");
          event.target.value = "";
        }
      }
    }
    
    // -------------------------
    // C·∫≠p nh·∫≠t th·ªùi gian c·∫≠p nh·∫≠t cu·ªëi
    // -------------------------
    function updateLastUpdated() {
      const nowStr = new Date().toLocaleString("vi-VN");
      document.getElementById("lastUpdated").innerText = `L·∫ßn c·∫≠p nh·∫≠t cu·ªëi: ${nowStr}`;
      localStorage.setItem(getLastUpdatedKey(), nowStr);
    }
    
    // -------------------------
    // H√†m copy d·ªØ li·ªáu (gi·ªØ nguy√™n)
    // -------------------------
    function copyValues() {
      let total = Object.values(data).reduce((sum, value) => sum + value, 0);
      if (total === 0) {
        alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p.");
        return;
      }
      let dataWithPercentages = Object.entries(data).map(([key, value]) => {
        let percentage = (value / total) * 100;
        return { key, value, percentage };
      });
      dataWithPercentages.forEach(item => {
        item.percentage = Math.round(item.percentage * 100) / 100;
      });
      let totalPercentage = dataWithPercentages.reduce((sum, item) => sum + item.percentage, 0);
      let diff = Math.round((100 - totalPercentage) * 100) / 100;
      let maxItem = dataWithPercentages.reduce((max, item) => item.value > max.value ? item : max, dataWithPercentages[0]);
      maxItem.percentage += diff;
      let textToCopy = dataWithPercentages.map((item, index) =>
        `${index + 1}. ${item.key}: ${item.percentage.toFixed(2)}%`
      ).join("\n");
      navigator.clipboard.writeText(textToCopy).then(() => {
        document.getElementById("copiedMessage").style.display = "block";
        setTimeout(() => {
          document.getElementById("copiedMessage").style.display = "none";
        }, 2000);
      }).catch(err => {
        alert("L·ªói sao ch√©p d·ªØ li·ªáu. H√£y th·ª≠ l·∫°i.");
        console.error(err);
      });
    }
    
    // -------------------------
    // H√†m t√≠nh k·∫øt qu·∫£ t·ªïng h·ª£p cho t√¨m ki·∫øm (gi·ªØ nguy√™n)
    // -------------------------
    function calculateAggregatedResults(aggregatedData) {
      let total = Object.values(aggregatedData).reduce((acc, val) => acc + val, 0);
      let sortedData = Object.entries(aggregatedData)
        .map(([key, value]) => [key, value, (value / total * 100)])
        .sort((a, b) => b[2] - a[2]);
      sortedData.forEach(item => {
        item[2] = Math.round(item[2] * 100) / 100;
      });
      let totalPercentage = sortedData.reduce((acc, item) => acc + item[2], 0);
      let diff = Math.round((100 - totalPercentage) * 100) / 100;
      if (sortedData.length > 0) {
        sortedData[0][2] += diff;
      }
      return sortedData;
    }
    
    function copySearchResults() {
      if (!window.searchAggregatedData) {
        alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p!");
        return;
      }
      const aggregatedData = window.searchAggregatedData;
      let total = Object.values(aggregatedData).reduce((sum, value) => sum + value, 0);
      if (total === 0) {
        alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p.");
        return;
      }
      let dataWithPercentages = Object.entries(aggregatedData).map(([key, value]) => {
        let percentage = (value / total) * 100;
        return { key, value, percentage };
      });
      dataWithPercentages.forEach(item => {
        item.percentage = Math.round(item.percentage * 100) / 100;
      });
      let totalPercentage = dataWithPercentages.reduce((sum, item) => sum + item.percentage, 0);
      let diff = Math.round((100 - totalPercentage) * 100) / 100;
      let maxItem = dataWithPercentages.reduce((max, item) => {
        return item.value > max.value ? item : max;
      }, dataWithPercentages[0]);
      maxItem.percentage += diff;
      let textToCopy = dataWithPercentages.map((item, index) =>
        `${index + 1}. ${item.key}: ${item.percentage.toFixed(2)}%`
      ).join("\n");
      navigator.clipboard.writeText(textToCopy).then(() => {
        document.getElementById("copiedMessageSearch").style.display = "block";
        setTimeout(() => {
          document.getElementById("copiedMessageSearch").style.display = "none";
        }, 2000);
      }).catch(err => {
        alert("L·ªói sao ch√©p d·ªØ li·ªáu. H√£y th·ª≠ l·∫°i.");
        console.error(err);
      });
    }
    
    // -------------------------
    // Chuy·ªÉn ƒë·ªïi giao di·ªán t√¨m ki·∫øm
    // -------------------------
    function showSearchInterface() {
      document.getElementById("defaultInterface").style.display = "none";
      document.getElementById("searchInterface").style.display = "block";
      document.getElementById("searchResultContainer").style.display = "none";
      document.getElementById("noDataMessage").style.display = "none";
    }
    function backToDefault() {
      document.getElementById("searchInterface").style.display = "none";
      document.getElementById("defaultInterface").style.display = "flex";
    }
    
    // -------------------------
    // L·∫•y danh s√°ch key theo kho·∫£ng th·ªùi gian (format: "data-YYYY-M")
    // -------------------------
    function getMonthsInRange(from, to) {
      let result = [];
      let [startYear, startMonth] = from.split("-").map(Number);
      let [endYear, endMonth] = to.split("-").map(Number);
      let currentYear = startYear;
      let currentMonth = startMonth;
      while (currentYear < endYear || (currentYear === endYear && currentMonth <= endMonth)) {
        result.push(`data-${currentYear}-${currentMonth}`);
        currentMonth++;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        }
      }
      return result;
    }
    
    function searchData() {
      const fromMonth = document.getElementById("fromMonth").value;
      const toMonth = document.getElementById("toMonth").value;
      if (!fromMonth || !toMonth) {
        alert("Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian.");
        return;
      }
      const keys = getMonthsInRange(fromMonth, toMonth);
      let aggregatedData = {};
      categories.forEach(cat => aggregatedData[cat] = 0);
      let found = false;
      keys.forEach(key => {
        let stored = localStorage.getItem(key);
        if (stored) {
          try {
            let monthData = JSON.parse(stored);
            categories.forEach(cat => {
              if (monthData[cat]) {
                aggregatedData[cat] += Number(monthData[cat]);
              }
            });
            found = true;
          } catch(e) {
            console.error("L·ªói parse d·ªØ li·ªáu cho key " + key, e);
          }
        }
      });
      if (!found) {
        document.getElementById("noDataMessage").style.display = "block";
        document.getElementById("searchResultContainer").style.display = "none";
        return;
      }
      let total = Object.values(aggregatedData).reduce((acc, val) => acc + val, 0);
      if (total === 0) {
        document.getElementById("noDataMessage").style.display = "block";
        document.getElementById("searchResultContainer").style.display = "none";
        return;
      }
      window.searchAggregatedData = aggregatedData;
      let sortedData = calculateAggregatedResults(aggregatedData);
      let outputHTML = sortedData.map((item, index) =>
        `<tr>
           <td>${index + 1}</td>
           <td>${item[0]}</td>
           <td>${item[1]}</td>
           <td>${item[2].toFixed(2)}%</td>
         </tr>`
      ).join("");
      let html = `<table>
        <tr>
          <th>Rank</th>
          <th>N·ªôi dung</th>
          <th>Gi√° tr·ªã</th>
          <th>T·ª∑ l·ªá (%)</th>
        </tr>
        ${outputHTML}
      </table>`;
      document.getElementById("searchResult").innerHTML = html;
      document.getElementById("searchResultContainer").style.display = "block";
      document.getElementById("noDataMessage").style.display = "none";
    }
    
    // -------------------------
    // H√†m l·ªçc theo Th√°ng-NƒÉm (m·ªõi)
    // -------------------------
    function filterDataByMonth() {
      const select = document.getElementById("filterMonth");
      const monthStr = select.value;
      if (monthStr) {
        loadDataForMonth(monthStr);
      } else {
        loadDataForMonth(defaultMonth);
      }
    }
    
    // -------------------------
    // Kh·ªüi t·∫°o giao di·ªán v√† Chart
    // -------------------------
    createInputFields();
    const ctx = document.getElementById("barChart").getContext("2d");
    if (window.chart) {
      window.chart.destroy();
    }
    window.chart = new Chart(ctx, {
      type: "bar",
      data: { 
        labels: categories, 
        datasets: [{ 
          label: "S·ªë l·∫ßn nh·∫≠p", 
          data: categories.map(cat => data[cat]), 
          backgroundColor: "#3498db", 
          borderColor: "#2980b9", 
          borderWidth: 1 
        }] 
      },
      options: { 
        responsive: true, 
        scales: { y: { beginAtZero: true } } 
      }
    });
    
    updateChart();
    loadDataForMonth(defaultMonth);
    loadDailyData();
    summarizeValues();
    // ƒêi·ªÅn c√°c option l·ªçc theo Th√°ng-NƒÉm d·ª±a tr√™n localStorage
    function populateFilterOptions() {
      const select = document.getElementById("filterMonth");
      select.innerHTML = '<option value="">--Ch·ªçn Th√°ng-NƒÉm--</option>';
      const optionsSet = new Set();
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("data-")) {
          const parts = key.split("-");
          if (parts.length === 3) {
            const year = parts[1];
            const month = parts[2];
            const monthFormatted = ("0" + month).slice(-2);
            const optionValue = year + "-" + monthFormatted;
            optionsSet.add(optionValue);
          }
        }
      }
      const optionsArray = Array.from(optionsSet).sort();
      optionsArray.forEach(optionValue => {
        const option = document.createElement("option");
        option.value = optionValue;
        option.text = optionValue;
        select.appendChild(option);
      });
    }
    populateFilterOptions();
  </script>
</body>
</html>
