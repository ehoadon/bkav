<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nhập Dữ Liệu & Thống Kê (RTDB)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #eef2f5; color: #333; }
    .container { max-width: 1000px; margin: 20px auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header { display: flex; justify-content: space-between; align-items: center; background: #3498db; color: #fff; padding: 12px 20px; }
    .header h2 { font-size: 1.4rem; }
    .header .user-controls { display: flex; align-items: center; gap: 10px; }
    .header .user-controls span { font-size: 0.95rem; }
    #btnLogout { display: none; background: #2980b9; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #fff; }
    #btnLogout:hover { background: #2273a5; }
    #mainSection { display: none; padding: 20px; }
    .layout { display: flex; gap: 20px; align-items: stretch; }
    .panel { background: #fafafa; border: 1px solid #ddd; border-radius: 6px; padding: 16px; display: flex; flex-direction: column; }
    .panel-left, .panel-right { flex: 1; }
    .panel-left table { flex: 1; width: 100%; }
    .panel-left button { margin-top: auto; }
    .panel-right { display: flex; flex-direction: column; }
    .panel-summary { flex: 0 0 auto; margin-bottom: 12px; }
    .panel-stats { flex: 1; display: flex; flex-direction: column; }
    .chart-container { flex: 1; margin-bottom: 12px; }
    .filter-controls { display: flex; gap: 8px; margin-top: auto; }
    .filter-controls input[type="month"] { width: 120px; }
    .filter-controls button { flex: 1; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 0.95rem; }
    th { background: #f0f0f0; }
    input[type="number"], input[type="email"], input[type="password"] { width: 100%; padding: 6px; border: 1px solid #bbb; border-radius: 4px; }
    button.full { width: 100%; }
    button.primary { background: #3498db; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    button.primary:hover { background: #2980b9; }
    button.success { background: #27ae60; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; }
    button.success:hover { background: #219150; }
    .console { background: #222; color: #0f0; padding: 10px; border-radius: 4px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; }
    .msg { color: #27ae60; text-align: center; font-size: 0.9rem; margin-top: 6px; }
    #lastEntryLog { text-align: center; font-style: italic; margin: 10px 0; }
    #authSection { padding: 20px; }
    #authSection input, #authSection button { max-width: 300px; margin: 8px auto; display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Nhập Dữ Liệu & Thống Kê</h2>
      <div class="user-controls">
        <span id="welcomeMsg"></span>
        <button id="btnLogout">Đăng xuất</button>
      </div>
    </div>
    <div id="authSection">
      <h3 style="text-align:center; margin-bottom:12px;">Đăng nhập hệ thống</h3>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Mật khẩu" />
      <button id="btnLogin" class="primary full">Đăng nhập</button>
      <div class="msg" id="authMsg"></div>
    </div>
    <div id="mainSection">
      <div class="layout">
        <div class="panel panel-left">
          <h3>Nhập giá trị</h3>
          <table>
            <tr><th>Nội dung</th><th>Giá trị</th></tr>
            <tbody id="entryRows"></tbody>
          </table>
          <button id="btnSaveAll" class="primary full">Lưu tất cả</button>
          <div class="msg" id="saveAllMsg"></div>
        </div>
        <div class="panel panel-right">
          <div class="panel-summary">
            <h3>Tổng lượt nhập theo ngày</h3>
            <div id="dailySummary"></div>
          </div>
          <div class="panel-stats">
            <h3>Thống kê tháng</h3>
            <div class="chart-container"><canvas id="statsChart"></canvas></div>
            <div id="statsOutput"></div>
            <div class="filter-controls">
              <input type="month" id="monthPicker" />
              <button id="btnLoadStats" class="primary full">Tải thống kê</button>
              <button id="btnCopyMonthly" class="success full">Copy % tháng</button>
            </div>
          </div>
        </div>
      </div>
      <div id="lastEntryLog" class="msg"></div>
    </div>
    <div style="padding:20px;">
      <h3>Console Log</h3>
      <div id="logConsole" class="console"></div>
    </div>
  </div>

  <script>
    // console override with auto-scroll
    (function(){
      const c = document.getElementById('logConsole');
      ['log','error'].forEach(fn => {
        const orig = console[fn];
        console[fn] = (...args) => { orig.apply(console,args); c.textContent += args.join(' ') + '\n'; c.scrollTop = c.scrollHeight; };
      });
      console.log('Console initialized');
      window.addEventListener('error', e => console.error('ERROR:', e.message));
    })();

    // Firebase config
    const cfg = {apiKey:'AIzaSyDsdrQakeA8iZ3iVerSNRvXC9bneyzluSU',authDomain:'ehoadon-bkav.firebaseapp.com',databaseURL:'https://ehoadon-bkav-default-rtdb.firebaseio.com',projectId:'ehoadon-bkav'};
    firebase.initializeApp(cfg);
    const auth = firebase.auth(), db = firebase.database();
    const categories = ['Truyền nhận','TVAN','IVAN','eCT','eHD','CKS','AIBooks','eContract','eQLHĐ'];

    function buildEntryRows() {
      console.log('Building entry rows');
      document.getElementById('entryRows').innerHTML = categories.map(c => `
        <tr>
          <td>${c}</td>
          <td><input id="in-${c}" type="number" min="0" /></td>
        </tr>
      `).join('');
    }

    function getCurrentMonth() {
      const d = new Date(), y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    auth.onAuthStateChanged(async user => {
      console.log('Auth state changed:', user ? 'signed in' : 'signed out');
      const welcomeMsgEl = document.getElementById('welcomeMsg');
      const logoutBtn = document.getElementById('btnLogout');
      const authSection = document.getElementById('authSection');
      const mainSection = document.getElementById('mainSection');

      if (user) {
        logoutBtn.style.display = 'inline-block';
        authSection.style.display = 'none';
        mainSection.style.display = 'block';
        welcomeMsgEl.innerText = `Chào bạn: ${user.email}`;

        buildEntryRows();
        document.getElementById('monthPicker').value = getCurrentMonth();

        console.log('Loading last entry...');
        await loadLastEntry(user.uid);
        console.log('Loading daily summary...');
        await loadDailySummary();
        console.log('Loading monthly stats...');
        await loadStats();
      } else {
        logoutBtn.style.display = 'none';
        welcomeMsgEl.innerText = '';
        authSection.style.display = 'block';
        mainSection.style.display = 'none';
      }
    });

    document.getElementById('btnLogin').onclick = async () => {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      console.log('Attempt login with', email);
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        localStorage.setItem('lastLoginDate', new Date().toISOString().slice(0,10));
        console.log('Login successful');
      } catch(err) {
        console.error('Login error', err.message);
        document.getElementById('authMsg').innerText = err.message;
      }
    };

    document.getElementById('btnLogout').onclick = async () => {
      console.log('Signing out');
      await auth.signOut();
      localStorage.removeItem('lastLoginDate');
    };

    async function loadLastEntry(uid) {
      const snap = await db.ref(`users/${uid}/lastEntry`).once('value');
      const ts = snap.val();
      console.log('Last entry timestamp:', ts);
      document.getElementById('lastEntryLog').innerText = ts ? `Lần nhập cuối: ${ts}` : '';
    }

    async function loadDailySummary() {
      const snap = await db.ref(`users/${auth.currentUser.uid}/dailySummary`).once('value');
      const obj = snap.val() || {};
      console.log('Daily summary data:', obj);
      let html = '<table><tr><th>Ngày</th><th>Tổng</th></tr>';
      Object.keys(obj).sort().forEach(k => html += `<tr><td>${k}</td><td>${obj[k]}</td></tr>`);
      html += '</table>';
      document.getElementById('dailySummary').innerHTML = html;
    }

    document.getElementById('btnSaveAll').onclick = async () => {
      const u = auth.currentUser;
      if (!u) return;
      const now = new Date(), y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
      const mk = `${y}-${m}`, dk = `${y}-${m}-${d}`;
      let dailyTotal = 0;

      console.log('Saving entries...');
      for (const c of categories) {
        const inp = document.getElementById(`in-${c}`);
        const val = parseInt(inp.value) || 0;
        if (val > 0) {
          const ref = db.ref(`users/${u.uid}/monthly/${mk}/${c}`);
          const prev = (await ref.once('value')).val() || 0;
          await ref.set(prev + val);
          console.log(`Saved ${c}: +${val} (new total: ${prev + val})`);
          dailyTotal += val;
        }
        inp.value = '';
      }

      const dRef = db.ref(`users/${u.uid}/dailySummary/${dk}`);
      const prevDay = (await dRef.once('value')).val() || 0;
      await dRef.set(prevDay + dailyTotal);
      console.log(`Updated daily summary for ${dk}: +${dailyTotal} (new total: ${prevDay + dailyTotal})`);

      const ts = new Date().toLocaleString('vi-VN');
      await db.ref(`users/${u.uid}/lastEntry`).set(ts);
      console.log('Set last entry timestamp to', ts);

      document.getElementById('saveAllMsg').innerText = dailyTotal > 0 ? 'Lưu xong!' : 'Chưa nhập giá trị.';
      setTimeout(() => document.getElementById('saveAllMsg').innerText = '', 2000);
      document.getElementById('lastEntryLog').innerText = `Lần nhập cuối: ${ts}`;

      console.log('Reloading summaries and stats');
      await loadDailySummary();
      await loadStats();
    };

    let chart;
    function initChart() {
      const ctx = document.getElementById('statsChart').getContext('2d');
      chart = new Chart(ctx, { type: 'bar', data: { labels: categories, datasets: [{ label: 'Giá trị', data: [], backgroundColor: '#3498db' }] }, options: { scales: { y: { beginAtZero: true } } } });
      console.log('Chart initialized');
    }

    async function loadStats() {
      const mk = document.getElementById('monthPicker').value;
      console.log('Loading stats for month', mk);
      const snap = await db.ref(`users/${auth.currentUser.uid}/monthly/${mk}`).once('value');
      const obj = snap.val() || {};
      console.log('Raw monthly data:', obj);

      const raw = categories.map(name => ({ name, value: obj[name] || 0 }));
      const total = raw.reduce((sum, r) => sum + r.value, 0);
      let dataList = raw.map(r => ({ name: r.name, value: r.value, pct: total > 0 ? Math.round(r.value / total * 10000) / 100 : 0 }));
      if (total > 0) {
        const maxIdx = dataList.reduce((mi, cur, i, arr) => cur.pct > arr[mi].pct ? i : mi, 0);
        const sumPct = dataList.reduce((s, i) => s + i.pct, 0);
        const diff = Math.round((100 - sumPct) * 100) / 100;
        dataList[maxIdx].pct += diff;
      }

      console.log('Processed stats data:', dataList);
      const values = dataList.map(r => r.value);

      if (!chart) initChart();
      chart.data.datasets[0].data = values;
      chart.update();
      console.log('Chart updated with values', values);

      const sorted = [...dataList].sort((a, b) => b.pct - a.pct);
      let html = '<h4>Thống kê Giá trị & %</h4><table><tr><th>STT</th><th>Nội dung</th><th>Giá trị</th><th>Tỷ lệ %</th></tr>';
      sorted.forEach((i, idx) => html += `<tr><td>${idx+1}</td><td>${i.name}</td><td>${i.value}</td><td>${i.pct.toFixed(2)}%</td></tr>`);
      html += '</table>';
      document.getElementById('statsOutput').innerHTML = html;

      console.log('Rendered stats table');
      window.pctOriginalCopy = dataList;
    }

    document.getElementById('btnLoadStats').onclick = loadStats;
    document.getElementById('btnCopyMonthly').onclick = () => {
      const arr = window.pctOriginalCopy || [];
      if (!arr.length) return alert('Chưa có thống kê');
      const lines = arr.map((i, idx) => `${idx+1}. ${i.name}: ${i.pct.toFixed(2)}%`);
      navigator.clipboard.writeText(lines.join('\n')).then(() => console.log('Copied monthly percentages to clipboard'));
    };
  </script>
</body>
</html>
