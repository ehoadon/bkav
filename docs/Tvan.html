<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Đối soát lỗi TVAN v3.0 (Quản lý Quy tắc)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #007bff; /* Changed slightly to a vibrant blue */
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --lighter-gray: #e9ecef;
            --dark-color: #343a40;
            --white-color: #fff;
            --border-color: #dee2e6;
            --box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); /* Slightly more prominent shadow */
            --border-radius: 8px;
            --background-dark: #1a202c; /* Dark background from image */
            --card-dark: #2d3748; /* Slightly lighter card background */
            --text-light: #e2e8f0; /* Light text color */
            --accent-purple: #805ad5; /* Accent color from image */
            --accent-green: #38b2ac; /* Another accent color */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0; /* Removed padding here, added to container */
            background-color: var(--background-dark); /* Dark background */
            color: var(--text-light); /* Light text */
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 20px auto;
            background-color: transparent; /* No background, cards handle it */
            padding: 20px; /* Added padding to container */
            border-radius: 0;
            box-shadow: none;
        }
        .card {
            background-color: var(--card-dark); /* Dark card background */
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1); /* Subtle border */
        }
        h2, h3, h4 {
            color: var(--primary-color); /* Kept primary color for headings for now */
            border-bottom: 2px solid var(--accent-purple); /* Accent border */
            padding-bottom: 10px;
            margin-top: 0;
            color: var(--text-light); /* Headings text light */
        }
        h4 {
            border-bottom: none;
            color: var(--text-light);
        }
        h2 i, h3 i {
            margin-right: 10px;
            color: var(--accent-purple); /* Icon color */
        }
        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease, transform 0.1s ease;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }
        button i {
            margin-right: 8px;
        }
        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
        }
        .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--danger-color); padding: 5px 10px; font-size: 14px; } .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: var(--warning-color); color: #212529; padding: 5px 10px; font-size: 14px; } .btn-warning:hover { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); } .btn-info:hover { background-color: #138496; }
        .btn-secondary { background-color: var(--secondary-color); } .btn-secondary:hover { background-color: #5a6268; }
        .btn-move { padding: 5px 10px; font-size: 14px; }
        input, select {
            padding: 10px;
            margin: 5px 0 15px 0;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
            background-color: var(--background-dark); /* Dark input background */
            color: var(--text-light); /* Light input text */
        }
        input::placeholder {
            color: var(--secondary-color);
        }
        select {
            -webkit-appearance: none; /* Remove default arrow on select */
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px; /* Make space for the arrow */
        }

        .input-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allows items to wrap on smaller screens */
            align-items: flex-end;
            margin-top: 15px;
            background-color: var(--card-dark); /* Darker background for filter group */
            padding: 15px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-group > * {
            flex: 1 1 200px; /* Adjusted flex-basis for better wrapping */
        }
        .pagination-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap; /* Allow pagination controls to wrap */
        }
        .pagination-controls .page-jump-input {
            width: 60px;
            text-align: center;
            padding: 5px;
            height: 31px;
            margin: 0;
        }
        .pagination-controls .btn-move {
            height: 31px;
        }
        .table-wrapper {
            overflow-x: auto; /* Enable horizontal scrolling for tables */
            max-height: 450px;
            border-radius: var(--border-radius); /* Apply border-radius to the wrapper */
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: var(--card-dark);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0; /* Remove top margin, handled by wrapper */
            font-size: 0.9em;
            background-color: var(--card-dark); /* Table background */
            min-width: 800px; /* Ensure table doesn't get too small and triggers scroll */
        }
        tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05); /* Lighter hover for dark theme */
        }
        .empty-row td {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
            font-size: 1.1em;
        }
        th, td {
            border: 1px solid rgba(255, 255, 255, 0.1); /* Lighter borders */
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
            white-space: nowrap; /* Prevent text wrapping in cells by default */
        }
        th {
            background-color: var(--accent-purple); /* Darker header background */
            color: var(--white-color);
            position: sticky;
            top: 0;
            z-index: 2; /* Increased z-index to ensure it stays on top */
        }
        td {
            color: var(--text-light); /* Light text for table data */
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
        }
        .sortable-header:hover {
            background-color: #6a40b8; /* Darker hover for header */
        }
        .sort-indicator {
            margin-left: 5px;
            font-size: 0.8em;
            display: inline-block;
            width: 10px;
        }
        td.col-action {
            text-align: center;
            display: flex; /* Use flexbox for action buttons */
            gap: 5px;
            justify-content: center;
            align-items: center;
            white-space: normal; /* Allow action column to wrap */
            min-width: 120px; /* Give more space for buttons */
        }
        th.col-action {
            background-color: var(--secondary-color);
            text-align: center;
        }
        td.editable {
            background-color: rgba(255, 255, 255, 0.05); /* Subtle highlight for editable cells */
            cursor: text;
        }
        .edit-in-place {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            border: 1px solid var(--primary-color);
            background-color: var(--background-dark);
            color: var(--text-light);
        }
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-weight: 500;
            display: none;
        }
        .message.success-message { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.warning-message { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .message.info-message { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #loader { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; }
        .spinner { border: 8px solid rgba(255, 255, 255, 0.3); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .drop-zones-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow drop zones to wrap */
        }
        .drop-zone {
            flex: 1;
            min-width: 280px; /* Ensure drop zone is not too small */
            border: 2px dashed rgba(255, 255, 255, 0.3); /* Lighter dashed border */
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            color: var(--secondary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            cursor: pointer;
            background-color: var(--background-dark); /* Darker background */
        }
        .drop-zone.dragover {
            background-color: rgba(255, 255, 255, 0.05); /* Light hover for dark theme */
            border-color: var(--primary-color);
        }
        .file-name {
            font-weight: bold;
            color: var(--text-light); /* Light text for file name */
            display: block;
            margin-top: 10px;
            word-break: break-all;
        }
        #standardValueGroup { display: none; }
        .chart-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
            color: var(--text-light);
        }
        .chart-options label {
            cursor: pointer;
            font-weight: 500;
        }
        .chart-options input {
            width: auto;
            margin-right: 5px;
            accent-color: var(--primary-color); /* Style radio buttons */
        }
        .tab-container {
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            display: flex;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            background-color: var(--card-dark); /* Match card background */
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: var(--border-radius) var(--border-radius) 0 0; /* Rounded top corners */
            overflow-x: auto; /* Allow tabs to scroll if too many */
            white-space: nowrap; /* Prevent tabs from wrapping */
        }
        .tab-link {
            background-color: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 1.1em;
            cursor: pointer;
            position: relative;
            color: var(--secondary-color);
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
            margin-bottom: -2px; /* Pull tabs up to overlap border */
            flex-shrink: 0; /* Prevent tabs from shrinking */
        }
        .tab-link.active {
            background-color: var(--card-dark);
            font-weight: 600;
            color: var(--primary-color);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--card-dark); /* Hide bottom border for active tab */
            z-index: 1; /* Bring active tab to front */
        }
        .tab-link:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
        }
        .tab-content { display: none; padding-top: 15px; } /* Add padding for content below tabs */
        .modal {
            display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); /* Darker overlay */
        }
        .modal-content {
            background-color: var(--card-dark); /* Modal background */
            color: var(--text-light); /* Modal text */
            margin: 5% auto; /* Reduced top margin */
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%; /* Responsive width */
            max-width: 1000px; /* Increased max-width for rule management */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .modal-close:hover, .modal-close:focus { color: var(--text-light); text-decoration: none; cursor: pointer; }
        
        /* --- NEW STYLES FOR UI IMPROVEMENTS --- */
        #overviewDashboardSection {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Adjusted minmax for better layout */
            gap: 25px;
        }
        .summary-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .summary-chart-container {
            position: relative;
            width: 180px;
            height: 180px;
            min-width: 180px; /* Ensure it doesn't shrink */
        }
        .summary-legend-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            color: var(--text-light);
        }
        .summary-item {
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }
        .summary-item .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Added border to dots */
        }
        .summary-item .count {
            font-weight: 600;
            color: var(--text-light);
            margin-left: auto;
            padding-left: 20px;
        }
        .analysis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Adjusted minmax for analysis cards */
            gap: 25px;
        }
        .analysis-card {
            background-color: var(--background-dark); /* Darker background for analysis cards */
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .analysis-card h4 {
            color: var(--text-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .analysis-card #mstErrorChart { max-height: 300px; }
        #alertsContainer .alert {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.95em;
            border-left: 5px solid;
            color: var(--dark-color); /* Default text for alerts (light background) */
        }
        #alertsContainer .alert.alert-spike { border-left-color: var(--warning-color); background-color: #fffaf0; }
        #alertsContainer .alert.alert-new { border-left-color: var(--info-color); background-color: #f1faff; }
        #alertsContainer .alert strong { color: var(--danger-color); }
        #alertsContainer .alert .error-code { font-weight: bold; color: var(--dark-color); }
        #alertsContainer .view-chart-link { color: var(--primary-color); cursor: pointer; font-weight: bold; text-decoration: underline; margin-left: 10px; }
        .toggle-filter-btn {
            width: 100%;
            text-align: left;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter button for toggle */
            color: var(--text-light);
            margin-bottom: 10px;
            font-weight: 600;
            border-radius: 5px;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toggle-filter-btn:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .toggle-filter-btn .fa-chevron-down { float: right; transition: transform 0.3s ease; }
        .toggle-filter-btn.active .fa-chevron-down { transform: rotate(180deg); }
        .collapsible-filters {
            display: none;
            padding-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--card-dark);
        }
        .collapsible-filters .input-group {
            background-color: transparent; /* Remove extra background for inner group */
            border: none;
            padding: 0;
            margin-top: 0;
        }

        /* Chart container styling for the main error chart */
        #errorChartSection > div {
            background-color: var(--background-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Chart.js specific styling for dark theme */
        .chartjs-render-monitor {
            background-color: var(--background-dark); /* Ensure chart background matches card */
        }
        canvas {
            max-width: 100%; /* Ensure charts are responsive */
            height: auto;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            h2 {
                font-size: 1.5em;
            }
            h3 {
                font-size: 1.2em;
            }
            button {
                padding: 8px 15px;
                font-size: 14px;
            }
            input, select {
                margin-bottom: 10px;
            }
            .input-group {
                gap: 10px;
            }
            .input-group > * {
                flex-basis: 100%; /* Stack inputs on small screens */
            }
            .drop-zones-container {
                flex-direction: column; /* Stack drop zones */
            }
            .drop-zone {
                min-width: unset;
                width: 100%;
            }
            .summary-container {
                flex-direction: column; /* Stack summary items */
                gap: 20px;
            }
            .summary-chart-container {
                width: 150px;
                height: 150px;
            }
            .analysis-container {
                grid-template-columns: 1fr; /* Stack analysis cards */
            }
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
            th, td {
                padding: 8px 10px;
                font-size: 0.85em;
            }
            td.col-action {
                flex-direction: column; /* Stack action buttons in column */
                gap: 2px;
                min-width: 80px; /* Adjust min-width */
            }
            .tab-link {
                padding: 10px 15px;
                font-size: 1em;
            }
            .pagination-controls {
                justify-content: center;
            }
            .pagination-controls .page-jump-input {
                width: 45px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            .tab-container {
                overflow-x: auto; /* Ensure tabs scrollable on very small screens */
            }
            .tab-link {
                font-size: 0.9em;
            }
            .pagination-controls {
                flex-direction: column; /* Stack pagination controls */
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="bulkEditModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="modal-close" id="bulkEditCloseBtn">&times;</span>
            <h3 id="bulkEditTitle">Sửa hàng loạt</h3>
            <div><label for="bulkEditColumn">Chọn cột để sửa:</label><select id="bulkEditColumn"><option value="MÔ TẢ LỖI">Mô tả lỗi</option><option value="MST">Mã số thuế</option><option value="MẪU SỐ KÝ HIỆU">Mẫu số ký hiệu</option><option value="SỐ HĐ">Số hóa đơn</option></select></div>
            <div><label for="bulkEditValue">Nhập giá trị mới:</label><input type="text" id="bulkEditValue" placeholder="Nhập giá trị sẽ được áp dụng..."></div>
            <button id="saveBulkEditBtn" class="btn-success"><i class="fas fa-save"></i> Lưu thay đổi</button>
        </div>
    </div>
    <div id="trendChartModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="trendChartCloseBtn">&times;</span>
            <h3 id="trendChartTitle">Biểu đồ Xu hướng Lỗi</h3>
            <canvas id="errorTrendChart"></canvas>
        </div>
    </div>
    
    <!-- ==================================================== -->
    <!-- MODAL QUẢN LÝ QUY TẮC - ĐÃ ĐƯỢC NÂNG CẤP -->
    <!-- ==================================================== -->
    <div id="ruleManagementModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="ruleMgmtCloseBtn">&times;</span>
            <h3><i class="fas fa-database"></i> Quản lý Quy tắc Đối soát (Nâng cao)</h3>
            
            <!-- Form Thêm/Sửa Quy tắc -->
            <div class="content" style="display: block; padding: 0; border: none;">
                <h4>Thêm/Cập nhật quy tắc</h4>
                <input type="hidden" id="editingRuleKey"> <!-- Input ẩn để lưu key khi sửa -->
                <div class="input-group">
                    <div><label for="newRuleAction">Hành động của Quy tắc:</label><select id="newRuleAction"><option value="INCLUDE">Bao gồm (Lấy vào bảng kết xuất)</option><option value="EXCLUDE">Loại trừ (Ẩn khỏi bảng thủ công)</option><option value="STANDARDIZE">Chuẩn hóa (Ghi đè Mô tả lỗi)</option></select></div>
                    <div><label for="newMaTD">Mã Loại Thông Điệp:</label><input type="text" id="newMaTD" placeholder="Bắt buộc"></div>
                    <div><label for="newMaLoi">Mã Lỗi:</label><input type="text" id="newMaLoi" placeholder="Bắt buộc cho Lấy/Loại trừ"></div>
                </div>
                <div class="input-group">
                    <div style="flex-grow: 2;"><label for="newMatchType">Loại so sánh Mô tả lỗi:</label><select id="newMatchType"><option value="EXACT">Khớp chính xác</option><option value="CONTAINS">Chứa chuỗi ký tự</option><option value="REGEX">Biểu thức chính quy</option></select></div>
                    <div style="flex-grow: 3;"><label for="newMatchValue">Giá trị so sánh:</label><input type="text" id="newMatchValue" placeholder="Bắt buộc"></div>
                </div>
                <div id="standardValueGroup">
                        <label for="newStandardValue">Giá trị Chuẩn hóa để Ghi đè:</label>
                        <input type="text" id="newStandardValue" placeholder="Bắt buộc khi hành động là Chuẩn hóa">
                </div>
                <button id="saveRuleBtn"><i class="fas fa-save"></i> Lưu Quy tắc</button>
                <button id="clearRuleFormBtn" class="btn-secondary" style="display:none;"><i class="fas fa-eraser"></i> Hủy Sửa</button>
                <div id="firebaseMessage" class="message"></div>
            </div>

            <!-- Bảng hiển thị danh sách quy tắc -->
            <div class="content" style="display: block; padding: 15px 0 0 0; border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 20px;">
                <h4>Danh sách Quy tắc hiện có (<span id="rulesCount">0</span>)</h4>
                <div class="table-wrapper" style="max-height: 300px;">
                    <table id="rulesDataTable">
                        <thead>
                            <tr>
                                <th class="col-action" style="min-width: 100px;">Hành động</th>
                                <th>Hành động Quy tắc</th>
                                <th>Mã Loại TĐ</th>
                                <th>Mã Lỗi</th>
                                <th>Loại so sánh</th>
                                <th style="min-width: 200px;">Giá trị so sánh</th>
                                <th style="min-width: 200px;">Giá trị Chuẩn hóa</th>
                            </tr>
                        </thead>
                        <tbody id="rulesTableBody">
                            <!-- Quy tắc sẽ được chèn vào đây bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <div id="loader"><div class="spinner"></div></div>

    <div class="container">
        <header class="card">
            <h2><i class="fas fa-tools"></i>Công cụ Đối soát lỗi TVAN</h2>
        </header>

        <main>
            <section class="card">
                <h3><i class="fas fa-file-upload"></i>Bước 1: Tải lên File Dữ liệu</h3>
                <div class="drop-zones-container">
                    <div class="drop-zone" id="dropZoneMT"><label for="fileMT"><b><i class="fas fa-file-alt"></i> Khu vực File MT</b></label><p>Kéo thả hoặc nhấn để chọn file</p><span class="file-name" id="fileNameMT">Chưa có file nào được chọn</span><input type="file" id="fileMT" accept=".xls,.xlsx" style="display:none;" multiple></div>
                    <div class="drop-zone" id="dropZoneLOI"><label for="fileLOI"><b><i class="fas fa-file-invoice"></i> Khu vực File LOI</b></label><p>Kéo thả hoặc nhấn để chọn file</p><span class="file-name" id="fileNameLOI">Chưa có file nào được chọn</span><input type="file" id="fileLOI" accept=".xls,.xlsx" style="display:none;" multiple></div>
                </div>
                <button onclick="handleFileUpload()" id="processBtn" class="btn-success"><i class="fas fa-cogs"></i>Xử lý & Đối soát</button>
                <div id="uploadMessage" class="message"></div>
            </section>
            
            <section id="processingSection" style="display:none;">
                    <div class="card" id="overviewDashboardSection">
                        <div id="summaryCard">
                            <h3><i class="fas fa-tachometer-alt"></i> Tổng quan Dữ liệu</h3>
                            <div class="summary-container">
                                <div class="summary-chart-container"><canvas id="summaryDonutChart"></canvas></div>
                                <div class="summary-legend-container">
                                    <div class="summary-item"><span class="legend-dot" style="background-color: var(--primary-color);"></span><span class="label">Tổng cộng</span><span class="count" id="totalCount">0</span></div>
                                    <div class="summary-item"><span class="legend-dot" style="background-color: var(--warning-color);"></span><span class="label">Cần xử lý</span><span class="count" id="sourceSummaryCount">0</span></div>
                                    <div class="summary-item"><span class="legend-dot" style="background-color: var(--secondary-color);"></span><span class="label">Đã loại trừ</span><span class="count" id="excludedSummaryCount">0</span></div>
                                    <div class="summary-item"><span class="legend-dot" style="background-color: var(--success-color);"></span><span class="label">Để kết xuất</span><span class="count" id="exportSummaryCount">0</span></div>
                                </div>
                            </div>
                        </div>
                        <div id="analysisSection">
                            <h3><i class="fas fa-chart-line"></i>Phân tích và Cảnh báo Tự động</h3>
                            <div class="analysis-container">
                                <div class="analysis-card">
                                    <h4><i class="fas fa-bell" style="color: var(--warning-color);"></i>Cảnh báo Thông minh</h4>
                                    <div id="alertsContainer"><p style="color: var(--secondary-color);">Không có cảnh báo nào.</p></div>
                                </div>
                                <div class="analysis-card">
                                    <h4><i class="fas fa-flag" style="color: var(--danger-color);"></i>Top 5 MST có nhiều lỗi nhất</h4>
                                    <canvas id="mstErrorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                <div class="card">
                    <h3><i class="fas fa-filter"></i>Bước 2: Sàng lọc dữ liệu</h3>
                    <div class="tab-container">
                        <button class="tab-link active" onclick="openTab(event, 'sourceTab')"><i class="fas fa-edit"></i> Cần xử lý (<span id="sourceCount">0</span>)</button>
                        <button class="tab-link" onclick="openTab(event, 'excludedTab')"><i class="fas fa-eye-slash"></i> Đã loại trừ (<span id="excludedCount">0</span>)</button>
                        <button class="tab-link" onclick="openTab(event, 'exportTab')"><i class="fas fa-check-circle"></i> Để kết xuất (<span id="exportCount">0</span>)</button>
                    </div>

                    <div id="sourceTab" class="tab-content" style="display: block;">
                        <div class="pagination-controls" id="sourcePagination"><span id="sourcePaginationInfo"></span><input type="number" class="page-jump-input" id="sourcePageInput" placeholder="Trang"><button class="btn-move" id="sourceGoBtn">Đi</button><button id="sourcePrevPageBtn" class="btn-move"><i class="fas fa-chevron-left"></i></button><button id="sourceNextPageBtn" class="btn-move"><i class="fas fa-chevron-right"></i></button></div>
                        <div class="filter-container">
                            <button class="toggle-filter-btn"><i class="fas fa-filter"></i> Lọc và Hành động <i class="fas fa-chevron-down"></i></button>
                            <div class="collapsible-filters">
                                <div class="input-group">
                                    <div><label for="filterNguon">Lọc theo Nguồn:</label><select id="filterNguon"><option value="">Tất cả</option><option value="MT">MT</option><option value="LOI">LOI</option></select></div>
                                    <div><label for="filterMaLoaiTD">Lọc theo Mã Loại TĐ:</label><select id="filterMaLoaiTD"></select></div>
                                    <div><label for="filterMaLoi">Lọc theo Mã Lỗi:</label><select id="filterMaLoi"></select></div>
                                    <div style="flex-grow: 2;"><label for="filterMoTaLoi">Tìm kiếm Mô tả lỗi:</label><input type="text" id="filterMoTaLoi" placeholder="Nhập từ khóa..."></div>
                                    <button onclick="moveSelectedFromSourceToExport()" class="btn-success"><i class="fas fa-share-square"></i>Chuyển mục đã chọn</button>
                                </div>
                            </div>
                        </div>
                        <div class="table-wrapper"><table id="sourceDataTable"><thead><tr><th class="col-action">
  <div style="display: flex; align-items: center; gap: 6px;">
    <input type="checkbox" id="selectAllSource" title="Chọn/Bỏ chọn tất cả các mục đã lọc">
    <span>Hành động</span>
  </div>
</th>
<th class="sortable-header" onclick="handleSort('source', 'sourceFile')">Nguồn<span id="sort-source-sourceFile" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MTĐ')">MTĐ<span id="sort-source-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MST')">MST<span id="sort-source-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-source-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÃ LỖI')">MÃ LỖI<span id="sort-source-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-source-MÔ TẢ LỖI" class="sort-indicator"></span></th></tr></thead><tbody id="sourceTableBody"></tbody></table></div>
                    </div>

                    <div id="excludedTab" class="tab-content">
                        <div class="pagination-controls" id="excludedPagination"><span id="excludedPaginationInfo"></span><input type="number" class="page-jump-input" id="excludedPageInput" placeholder="Trang"><button class="btn-move" id="excludedGoBtn">Đi</button><button id="excludedPrevPageBtn" class="btn-move"><i class="fas fa-chevron-left"></i></button><button id="excludedNextPageBtn" class="btn-move"><i class="fas fa-chevron-right"></i></button></div>
                        <div class="filter-container">
                             <button class="toggle-filter-btn"><i class="fas fa-filter"></i> Lọc dữ liệu <i class="fas fa-chevron-down"></i></button>
                             <div class="collapsible-filters">
                                <div class="input-group">
                                    <div><label for="filterExcludedNguon">Lọc theo Nguồn:</label><select id="filterExcludedNguon"><option value="">Tất cả</option><option value="MT">MT</option><option value="LOI">LOI</option></select></div>
                                    <div><label for="filterExcludedMaLoaiTD">Lọc theo Mã Loại TĐ:</label><select id="filterExcludedMaLoaiTD"></select></div>
                                    <div><label for="filterExcludedMaLoi">Lọc theo Mã Lỗi:</label><select id="filterExcludedMaLoi"></select></div>
                                    <div style="flex-grow: 2;"><label for="filterExcludedMoTaLoi">Tìm kiếm Mô tả lỗi:</label><input type="text" id="filterExcludedMoTaLoi" placeholder="Nhập từ khóa..."></div>
                                </div>
                            </div>
                        </div>
                        <div class="table-wrapper"><table id="excludedDataTable"><thead><tr><th class="col-action">Hành động</th><th class="sortable-header" onclick="handleSort('excluded', 'sourceFile')">Nguồn<span id="sort-excluded-sourceFile" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MTĐ')">MTĐ<span id="sort-excluded-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MST')">MST<span id="sort-excluded-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-excluded-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÃ LỖI')">MÃ LỖI<span id="sort-excluded-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-excluded-MÔ TẢ LỖI" class="sort-indicator"></span></th></tr></thead><tbody id="excludedTableBody"></tbody></table></div>
                    </div>

                    <div id="exportTab" class="tab-content">
                        <div class="pagination-controls" id="exportPagination"><span id="exportPaginationInfo"></span><input type="number" class="page-jump-input" id="exportPageInput" placeholder="Trang"><button class="btn-move" id="exportGoBtn">Đi</button><button id="exportPrevPageBtn" class="btn-move"><i class="fas fa-chevron-left"></i></button><button id="exportNextPageBtn" class="btn-move"><i class="fas fa-chevron-right"></i></button></div>
                        <div class="filter-container">
                            <button class="toggle-filter-btn"><i class="fas fa-filter"></i> Lọc và Hành động <i class="fas fa-chevron-down"></i></button>
                            <div class="collapsible-filters">
                                <div class="input-group">
                                    <button id="bulkEditBtn" class="btn-info" disabled><i class="fas fa-pencil-alt"></i> Sửa hàng loạt</button>
                                    <div style="flex:1 1 50px"></div> <div><label for="filterExportNguon">Lọc theo Nguồn:</label><select id="filterExportNguon"><option value="">Tất cả</option><option value="MT">MT</option><option value="LOI">LOI</option></select></div>
                                    <div><label for="filterExportMaLoaiTD">Lọc theo Mã Loại TĐ:</label><select id="filterExportMaLoaiTD"></select></div>
                                    <div><label for="filterExportMaLoi">Lọc theo Mã Lỗi:</label><select id="filterExportMaLoi"></select></div>
                                    <div style="flex-grow: 2;"><label for="filterExportMoTaLoi">Tìm kiếm Mô tả lỗi:</label><input type="text" id="filterExportMoTaLoi" placeholder="Nhập từ khóa..."></div>
                                </div>
                            </div>
                        </div>
                        <div class="table-wrapper"><table id="exportDataTable"><thead><tr><th class="col-action">
  <div style="display: flex; align-items: center; gap: 6px;">
    <input type="checkbox" id="selectAllExport" title="Chọn/Bỏ chọn tất cả các mục đã lọc">
    <span>Hành động</span>
  </div>
</th>
<th class="sortable-header" onclick="handleSort('export', 'TVAN')">TVAN<span id="sort-export-TVAN" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MTĐ')">MTĐ<span id="sort-export-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-export-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÃ LỖI')">MÃ LỖI<span id="sort-export-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-export-MÔ TẢ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'TIMELOG')">TIMELOG<span id="sort-export-TIMELOG" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'GỬI LẦN')">GỬI LẦN<span id="sort-export-GỬI LẦN" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MST')">MST<span id="sort-export-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MẪU SỐ KÝ HIỆU')">MẪU SỐ KÝ HIỆU<span id="sort-export-MẪU SỐ KÝ HIỆU" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'SỐ HĐ')">SỐ HĐ<span id="sort-export-SỐ HĐ" class="sort-indicator"></span></th></tr></thead><tbody id="exportTableBody"></tbody></table></div>
                    </div>
                </div>

                <div class="card" id="actionsCard">
                     <h3><i class="fas fa-cogs"></i> Bước 3: Hành động cuối cùng</h3>
                     <div class="input-group" style="background: none; border: none; padding: 0;">
                        <button onclick="exportToExcel()" id="exportBtn" class="btn-success"><i class="fas fa-file-excel"></i>Kết xuất Bảng 3 ra Excel</button>
                        <button id="openRuleMgmtBtn" class="btn-info"><i class="fas fa-database"></i> Mở Trình Quản lý Quy tắc</button>
                    </div>
                    <div id="exportMessage" class="message"></div>
                </div>

                <div class="card" id="errorChartSection" style="display:none;">
                    <h3><i class="fas fa-chart-bar"></i>Thống kê các lỗi cần xử lý</h3>
                    <div class="chart-options">
                        <label><input type="radio" name="chartViewMode" id="viewModeRemaining" value="remaining" checked> Công việc còn lại</label>
                        <label><input type="radio" name="chartViewMode" id="viewModeInitial" value="initial"> Tổng quan ban đầu</label>
                    </div>
                    <div style="position: relative; width: 90%; max-width: 900px; margin: auto; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--border-radius);"><canvas id="errorChart"></canvas></div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // --- CONFIG & GLOBAL VARIABLES ---
    const cfg = {
        apiKey: 'AIzaSyDsdrQakeA8iZ3iVerSNRvXC9bneyzluSU',
        authDomain: 'ehoadon-bkav.firebaseapp.com',
        databaseURL: 'https://ehoadon-bkav-default-rtdb.firebaseio.com',
        projectId: 'ehoadon-bkav',
        storageBucket: 'ehoadon-bkav.appspot.com',
        messagingSenderId: '688737951508',
        appId: '1:688737951508:web:965514a6a1f7c4de15ac01'
    };
    let db = null;
    try { firebase.initializeApp(cfg); db = firebase.database(); } 
    catch (error) { console.error("Firebase initialization error:", error); alert("Không thể kết nối tới Firebase."); }

    let firebaseRules = []; 
    let myErrorChart = null, summaryChart = null, mstErrorChart = null, errorTrendChart = null;
    let initialSourceDataForChart = [];
    let historicalData = [];

    const dataStores = {
        source: { data: [], sortState: { column: null, direction: 'asc' } },
        export: { data: [], sortState: { column: null, direction: 'asc' } },
        excluded: { data: [], sortState: { column: null, direction: 'asc' } }
    };
    
    const rowsPerPage = 100;
    let sourceCurrentPage = 1, excludedCurrentPage = 1, exportCurrentPage = 1;
    let selectedSourceRowIds = new Set(), selectedExportRowIds = new Set();

    // --- UTILITY FUNCTIONS ---
    function debounce(func, delay) { let timeout; return function(...args) { const context = this; clearTimeout(timeout); timeout = setTimeout(() => func.apply(context, args), delay); }; }
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function showMessage(elementId, text, type = 'warning', duration = 4000) { const el = document.getElementById(elementId); if(el) { el.textContent = text; el.className = `message ${type}-message`; el.style.display = 'block'; if (duration > 0) { setTimeout(() => { el.style.display = 'none'; }, duration); } } }
    function hideAllMessages() { document.querySelectorAll('.message').forEach(msg => msg.style.display = 'none'); }
    function readExcel(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array', cellDates: true }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; if (!worksheet) { resolve([]); return; } resolve(XLSX.utils.sheet_to_json(worksheet)); } catch (error) { reject(error); } }; reader.onerror = () => reject(new Error("Lỗi không thể đọc file.")); reader.readAsArrayBuffer(file); }); }
    
    function convertToDate(dateInput) {
        if (!dateInput) return null;
        if (dateInput instanceof Date && !isNaN(dateInput)) return dateInput;
        if (typeof dateInput === 'number') {
            return new Date(Math.round((dateInput - 25569) * 864e5));
        }
        if (typeof dateInput === 'string') {
            let d = new Date(dateInput);
            if (!isNaN(d)) return d;
            
            const parts = dateInput.match(/(\d+)/g);
            if (parts && parts.length === 3) {
                if (parts[0].length === 4) d = new Date(parts[0], parts[1] - 1, parts[2]);
                else if (parts[2].length === 4) d = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(d)) return d;
            }
        }
        return null;
    }

    function formatDate(date) {
        if (!date) return '';
        return `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;
    }

    function getFirebaseDateKey(date) {
        if (!date) return null;
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    
    // *** NEW: 1-Click Rule and Move Function ***
    async function addRuleAndMove(rowId, action = 'EXCLUDE') {
        const rowIndex = dataStores.source.data.findIndex(r => r.id === rowId);
        if (rowIndex === -1) {
            showMessage('uploadMessage', 'Không tìm thấy dòng để xử lý.', 'error');
            return;
        }
        const row = dataStores.source.data[rowIndex];

        const newRule = {
            rule_action: action,
            ma_loai_td: row['MÃ LOẠI TĐ'],
            ma_loi: row['MÃ LỖI'],
            match_type: 'EXACT', // Default to exact match for simplicity
            match_value: row['MÔ TẢ LỖI'],
            standard_value: '' 
        };

        if (!newRule.ma_loai_td || !newRule.ma_loi || !newRule.match_value) {
            showMessage('uploadMessage', `Không thể tạo quy tắc cho lỗi: '${row['MÔ TẢ LỖI']}' do thiếu thông tin.`, 'error');
            return;
        }

        try {
            await db.ref('error_definitions').push(newRule);
            
            // Add rule to local cache
            await fetchFirebaseErrors();
            
            // Move item locally
            const [movedRow] = dataStores.source.data.splice(rowIndex, 1);
            if (action === 'EXCLUDE') {
                dataStores.excluded.data.push(movedRow);
            }
            
            showMessage('uploadMessage', `Đã tạo quy tắc loại trừ và di chuyển lỗi.`, 'success');

            // Refresh UI
            displayAllTables();
            updateChartView();

        } catch (error) {
            showMessage('uploadMessage', `Lỗi khi lưu quy tắc vào Firebase: ${error.message}`, 'error');
        }
    }


    // --- CORE RECONCILIATION LOGIC ---
    function isMatch(excelRow, rule) { const maLoaiTDMatch = excelRow['MÃ LOẠI TĐ'].toString().trim() === rule.ma_loai_td.toString().trim(); if (!maLoaiTDMatch) return false; let maLoiMatch = true; if (rule.ma_loi) { maLoiMatch = excelRow['MÃ LỖI'].toString().trim() === rule.ma_loi.toString().trim(); } if (!maLoiMatch) return false; const moTaLoi = excelRow['MÔ TẢ LỖI'].toString(); const matchValue = rule.match_value.toString(); switch (rule.match_type) { case 'EXACT': return moTaLoi.trim() === matchValue.trim(); case 'CONTAINS': return moTaLoi.toLowerCase().includes(matchValue.toLowerCase()); case 'REGEX': try { const regex = new RegExp(matchValue, 'i'); return regex.test(moTaLoi); } catch (e) { console.error(`Regex không hợp lệ: "${matchValue}"`, e); return false; } default: return false; } }
    
    // UPDATED: fetchFirebaseErrors now stores the key
    async function fetchFirebaseErrors() {
        if (!db) return 0;
        firebaseRules = [];
        const snapshot = await db.ref('error_definitions').get();
        if (snapshot.exists()) {
            const data = snapshot.val();
            for (const key in data) {
                const rule = data[key];
                rule.key = key; // IMPORTANT: Store the key for editing/deleting
                rule.rule_action = rule.rule_action || 'INCLUDE';
                if (!rule.match_type && rule.mo_ta_loi) {
                    rule.match_type = 'EXACT';
                    rule.match_value = rule.mo_ta_loi;
                }
                firebaseRules.push(rule);
            }
        }
        return firebaseRules.length;
    }

    async function handleFileUpload() {
        hideAllMessages(); showLoader(true); showMessage('uploadMessage', 'Bắt đầu xử lý... Vui lòng đợi.', 'info', 0);
        const mtFiles = document.getElementById('fileMT').files; const loiFiles = document.getElementById('fileLOI').files;
        if (mtFiles.length === 0 || loiFiles.length === 0) { showMessage('uploadMessage', 'Vui lòng cung cấp ít nhất một file cho mỗi nguồn MT và LOI.', 'error'); showLoader(false); return; }
        
        try {
            const rulesCount = await fetchFirebaseErrors();
            showMessage('uploadMessage', `Đã tải ${rulesCount} quy tắc. Bắt đầu đọc file Excel...`, 'info', 0);
            
            const [mtDataArrays, loiDataArrays] = await Promise.all([ Promise.all(Array.from(mtFiles).map(file => readExcel(file))), Promise.all(Array.from(loiFiles).map(file => readExcel(file))) ]);
            const mtData = mtDataArrays.flat(); const loiData = loiDataArrays.flat();
            
            showMessage('uploadMessage', `Đọc file thành công. Tổng cộng ${mtData.length + loiData.length} dòng. Đang xử lý dữ liệu...`, 'info', 0);

            setTimeout(async () => {
                try {
                    processDataWithRules(mtData, loiData);
                    populateFilters(); 
                    displayAllTables(); 
                    updateSummaryBar(); 
                    openTab(null, 'sourceTab');
                    
                    document.getElementById('processingSection').style.display = 'block';
                    document.getElementById('overviewDashboardSection').style.display = 'grid';
                    document.getElementById('errorChartSection').style.display = 'block';
                    
                    updateChartView();
                    
                    await runAnalysisWorkflow();

                    showMessage('uploadMessage', `Xử lý hoàn tất!`, 'success');
                } catch (error) {
                    console.error("Lỗi trong quá trình xử lý dữ liệu:", error); 
                    showMessage('uploadMessage', `Lỗi xử lý dữ liệu: ${error.message}`, 'error'); 
                } finally {
                    showLoader(false); 
                }
            }, 100);

        } catch (error) { 
            console.error("Lỗi trong quá trình tải file:", error); 
            showMessage('uploadMessage', `Lỗi xử lý file: ${error.message}`, 'error'); 
            showLoader(false); 
        }
    }

    function processDataWithRules(mtData, loiData) {
        dataStores.source.data = []; dataStores.export.data = []; dataStores.excluded.data = [];
        initialSourceDataForChart = []; selectedSourceRowIds.clear(); selectedExportRowIds.clear();
        let idCounter = 0; let rawData = [];
        
        const mapRawData = (data, sourceIdentifier) => { if (!Array.isArray(data)) return; data.forEach(row => { 
            const dateObj = convertToDate(row['Ngày tạo'] || row['ngaytao'] || row['TIMELOG'] || row['TimeLog']);
            if (!dateObj) return; 
            const moTaLoiGoc = (row['Mô tả lỗi'] || row['MÔ TẢ LỖI'] || '').toString(); 
            rawData.push({ 
                id: `row-${idCounter++}`, 
                TVAN: 'tvan_bkav', 
                'MTĐ': row['Mã Thông điệp'] || row['MTĐ'] || '', 
                'MÃ LOẠI TĐ': (row['Mã loại thông điệp'] || row['MÃ LOẠI TĐ'] || '').toString().trim(), 
                'MÃ LỖI': (row['Mã Lôi'] || row['Mã Lỗi'] || row['MÃ LỖI'] || '').toString().trim(), 
                sourceFile: sourceIdentifier, 
                'MÔ TẢ LỖI': moTaLoiGoc, 
                'DATE_OBJECT': dateObj,
                TIMELOG: formatDate(dateObj),
                'GỬI LẦN': 1, 
                'MST': (row['Mã số thuế'] || row['MST'] || '').toString().trim(), 
                'MẪU SỐ KÝ HIỆU': (moTaLoiGoc.includes(';') && moTaLoiGoc.split(';')[1]) ? `1${moTaLoiGoc.split(';')[1]}` : '', 
                'SỐ HĐ': (moTaLoiGoc.includes(';') && moTaLoiGoc.split(';')[2]) ? moTaLoiGoc.split(';')[2] : '' 
            }); 
        }); };
        mapRawData(mtData, 'MT'); mapRawData(loiData, 'LOI');
        
        const standardizeRules = firebaseRules.filter(r => r.rule_action === 'STANDARDIZE');
        const filterRules = firebaseRules.filter(r => r.rule_action === 'INCLUDE' || r.rule_action === 'EXCLUDE');
        
        rawData.forEach(row => { const matchingStandardizeRule = standardizeRules.find(rule => isMatch(row, rule)); if (matchingStandardizeRule) { row['MÔ TẢ LỖI'] = matchingStandardizeRule.standard_value; } });
        
        initialSourceDataForChart = [...rawData];
        
        rawData.forEach(row => { const matchingFilterRule = filterRules.find(rule => isMatch(row, rule)); if (matchingFilterRule) { if (matchingFilterRule.rule_action === 'INCLUDE') dataStores.export.data.push(row); else dataStores.excluded.data.push(row); } else dataStores.source.data.push(row); });
    }

    function groupDataByDate(data) {
        return data.reduce((acc, row) => {
            const dateKey = getFirebaseDateKey(row.DATE_OBJECT);
            if (dateKey) {
                if (!acc[dateKey]) {
                    acc[dateKey] = {
                        date: dateKey,
                        totalErrors: 0,
                        errorCounts: {},
                        mstErrorCounts: {}
                    };
                }
                const dayData = acc[dateKey];
                dayData.totalErrors++;
                
                const errorCode = row['MÃ LỖI'] || 'UNKNOWN';
                dayData.errorCounts[errorCode] = (dayData.errorCounts[errorCode] || 0) + 1;
                
                const mst = row['MST'] || 'UNKNOWN_MST';
                if (mst && mst !== 'UNKNOWN_MST') {
                   dayData.mstErrorCounts[mst] = (dayData.mstErrorCounts[mst] || 0) + 1;
                }
            }
            return acc;
        }, {});
    }

    async function saveProcessingSummaries(groupedData) {
        if (!db) return;
        const savePromises = [];
        for (const dateKey in groupedData) {
            const summary = groupedData[dateKey];
            savePromises.push(db.ref(`processing_history/${dateKey}`).set(summary));
        }
        await Promise.all(savePromises);
        console.log(`Saved ${savePromises.length} summaries to Firebase.`);
    }

    async function fetchProcessingHistory(days = 30) {
        if (!db) return [];
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(endDate.getDate() - days);

        const snapshot = await db.ref('processing_history')
                                        .orderByKey()
                                        .startAt(getFirebaseDateKey(startDate))
                                        .endAt(getFirebaseDateKey(endDate))
                                        .get();
        const history = [];
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                history.push(childSnapshot.val());
            });
        }
        return history;
    }

    async function runAnalysisWorkflow() {
        const groupedData = groupDataByDate(initialSourceDataForChart);
        const datesProcessed = Object.keys(groupedData).sort();

        if (datesProcessed.length === 0) {
            document.getElementById('analysisSection').style.display = 'none';
            return;
        }

        await saveProcessingSummaries(groupedData);
        historicalData = await fetchProcessingHistory(30);

        const latestDateKey = datesProcessed[datesProcessed.length - 1];
        const latestDateData = historicalData.find(h => h.date === latestDateKey);
        const pastData = historicalData.filter(h => h.date !== latestDateKey);

        if (!latestDateData) {
            document.getElementById('analysisSection').style.display = 'none';
            return;
        }
        document.getElementById('analysisSection').style.display = 'block';

        const alertsContainer = document.getElementById('alertsContainer');
        alertsContainer.innerHTML = '';
        let alertsFound = 0;
        const SPIKE_THRESHOLD = 3; 

        const pastErrorStats = new Map();
        pastData.forEach(day => {
            for (const errorCode in day.errorCounts) {
                if (!pastErrorStats.has(errorCode)) {
                    pastErrorStats.set(errorCode, { total: 0, count: 0 });
                }
                const stats = pastErrorStats.get(errorCode);
                stats.total += day.errorCounts[errorCode];
                stats.count++;
            }
        });

        for (const errorCode in latestDateData.errorCounts) {
            const todayCount = latestDateData.errorCounts[errorCode];
            const historicalStats = pastErrorStats.get(errorCode);

            if (historicalStats) {
                if (todayCount > 5) {
                    const avgCount = historicalStats.total / historicalStats.count;
                    if (todayCount > avgCount * SPIKE_THRESHOLD) {
                        alertsFound++;
                        const alertEl = document.createElement('div');
                        alertEl.className = 'alert alert-spike';
                        alertEl.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i>
                            Lỗi <strong>'${errorCode}'</strong> tăng đột biến:
                            <strong>${todayCount}</strong> lần (TB ${avgCount.toFixed(1)}).
                            <span class="view-chart-link" data-error-code="${errorCode}">[Xem biểu đồ]</span>
                        `;
                        alertsContainer.appendChild(alertEl);
                    }
                }
            } else { 
                alertsFound++;
                const alertEl = document.createElement('div');
                alertEl.className = 'alert alert-new';
                alertEl.innerHTML = `
                    <i class="fas fa-lightbulb"></i>
                    Lỗi mới phát sinh: <span class="error-code">'${errorCode}'</span>
                    đã xuất hiện <strong>${todayCount}</strong> lần.
                `;
                alertsContainer.appendChild(alertEl);
            }
        }
        
        if (alertsFound === 0) {
            alertsContainer.innerHTML = `<p style="color: var(--secondary-color);">Không phát hiện tăng đột biến hoặc lỗi mới cho ngày ${latestDateKey}.</p>`;
        }
        renderMstErrorChart(latestDateData, pastData);
    }
    
    function renderMstErrorChart(currentDateData, pastHistory) {
        const ctx = document.getElementById('mstErrorChart').getContext('2d');
        if (mstErrorChart) mstErrorChart.destroy();

        const sortedMst = Object.entries(currentDateData.mstErrorCounts)
                                .sort(([,a],[,b]) => b - a)
                                .slice(0, 5);
        
        if (sortedMst.length === 0) {
             document.getElementById('mstErrorChart').parentElement.style.display = 'none';
             return;
        }
        document.getElementById('mstErrorChart').parentElement.style.display = 'block';

        const labels = sortedMst.map(([mst]) => mst);
        const data = sortedMst.map(([, count]) => count);

        mstErrorChart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels, 
                datasets: [{ 
                    label: `Số lỗi ngày ${currentDateData.date}`, 
                    data, 
                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1
                }] 
            },
            options: {
                indexAxis: 'y',
                responsive: true, 
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            footer: function(tooltipItems) {
                                const mst = tooltipItems[0].label;
                                let totalPastCount = 0; let daysWithErrors = 0;
                                pastHistory.forEach(day => { if(day.mstErrorCounts && day.mstErrorCounts[mst]) { totalPastCount += day.mstErrorCounts[mst]; daysWithErrors++; } });
                                if (daysWithErrors > 0) { const avg = (totalPastCount / daysWithErrors).toFixed(1); return `Lịch sử: ${totalPastCount} lỗi trong ${daysWithErrors} ngày (TB: ${avg}/ngày).`; }
                                return 'Lịch sử: Chưa ghi nhận lỗi cho MST này.';
                            }
                        }
                    }
                },
                scales: { 
                    x: { 
                        beginAtZero: true,
                        title: { display: true, text: 'Số lượng lỗi', color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },

                        ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() }
                    }
                }
            }
        });
    }

    function displayTrendChart(errorCode) {
        const modal = document.getElementById('trendChartModal');
        const title = document.getElementById('trendChartTitle');
        title.textContent = `Biểu đồ xu hướng cho Mã lỗi: ${errorCode}`;
        
        const sortedHistory = [...historicalData].sort((a, b) => new Date(a.date) - new Date(b.date));
        const labels = sortedHistory.map(h => new Date(h.date));
        const data = sortedHistory.map(dayData => dayData.errorCounts[errorCode] || 0);

        const ctx = document.getElementById('errorTrendChart').getContext('2d');
        if(errorTrendChart) errorTrendChart.destroy();

        errorTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `Số lần xuất hiện lỗi '${errorCode}'`,
                    data: data,
                    borderColor: 'rgba(0, 123, 255, 1)',
                    backgroundColor: 'rgba(0, 123, 255, 0.2)',
                    fill: true, tension: 0.1
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy', displayFormats: { day: 'dd/MM' } },
                        title: { display: true, text: 'Ngày', color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },
                        ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Số lượng', color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },
                        ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim()
                        }
                    }
                }
            }
        });
        modal.style.display = 'block';
    }


    // --- DISPLAY & UI INTERACTION FUNCTIONS ---
    function openTab(evt, tabName) { document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none'); document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active')); document.getElementById(tabName).style.display = 'block'; if (evt) evt.currentTarget.classList.add('active'); else document.querySelector(`.tab-link[onclick*="${tabName}"]`).classList.add('active'); }
    function updateSummaryBar() { const sourceCount = dataStores.source.data.length, excludedCount = dataStores.excluded.data.length, exportCount = dataStores.export.data.length; document.getElementById('totalCount').textContent = (sourceCount + excludedCount + exportCount).toLocaleString('vi-VN'); document.getElementById('sourceSummaryCount').textContent = sourceCount.toLocaleString('vi-VN'); document.getElementById('excludedSummaryCount').textContent = excludedCount.toLocaleString('vi-VN'); document.getElementById('exportSummaryCount').textContent = exportCount.toLocaleString('vi-VN'); renderSummaryChart(sourceCount, excludedCount, exportCount); }
    function renderSummaryChart(source, excluded, exported) { const ctx = document.getElementById('summaryDonutChart').getContext('2d'); if (summaryChart) summaryChart.destroy(); if (source === 0 && excluded === 0 && exported === 0) return; summaryChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Cần xử lý', 'Đã loại trừ', 'Để kết xuất'], datasets: [{ data: [source, excluded, exported], backgroundColor: ['#ffc107', '#6c757d', '#28a745'], borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; if (context.parsed !== null) label += context.parsed.toLocaleString('vi-VN'); return label; } } } } } }); }
    function displayAllTables() { sourceCurrentPage = 1; excludedCurrentPage = 1; exportCurrentPage = 1; displaySourceData(); displayExportData(); displayExcludedData(); updateSummaryBar(); }
    function updateTableCount(tableId, count) { document.getElementById(`${tableId}Count`).textContent = count.toLocaleString('vi-VN'); }
    function renderEmptyRow(tableBody, colSpan) { tableBody.innerHTML = `<tr class="empty-row"><td colspan="${colSpan}"><i class="fas fa-info-circle"></i> Không có dữ liệu phù hợp.</td></tr>`; }
function displaySourceData() {
    const tableBody = document.getElementById('sourceTableBody');
    let dataToDisplay = getFilteredSourceData();
    updateTableCount('source', dataToDisplay.length);

    if (dataToDisplay.length === 0) {
        renderEmptyRow(tableBody, 7); // Adjusted colspan
        renderPagination('source', 0, 1);
        return;
    }

    sortData(dataToDisplay, 'source');
    updateSortIndicators('source');

    const paginatedData = dataToDisplay.slice(
        (sourceCurrentPage - 1) * rowsPerPage,
        sourceCurrentPage * rowsPerPage
    );

    tableBody.innerHTML = '';

    paginatedData.forEach(row => {
        const isChecked = selectedSourceRowIds.has(row.id) ? 'checked' : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="col-action">
                <input type="checkbox" class="row-checkbox" data-table="source" data-row-id="${row.id}" ${isChecked}>
                <button class="btn-success btn-move" onclick="moveSingleItem('${row.id}', 'source', 'export')" title="Chuyển sang Bảng 3"><i class="fas fa-arrow-right"></i></button>
                <button class="btn-warning btn-move" onclick="addRuleAndMove('${row.id}', 'EXCLUDE')" title="Loại trừ & Tạo quy tắc vĩnh viễn"><i class="fas fa-ban"></i></button>
            </td>
            <td>${row.sourceFile.toUpperCase()}</td>
            <td>${row['MTĐ']}</td>
            <td>${row.MST}</td>
            <td>${row['MÃ LOẠI TĐ']}</td>
            <td>${row['MÃ LỖI']}</td>
            <td>${row['MÔ TẢ LỖI']}</td>
        `;
        tableBody.appendChild(tr);
    });

    renderPagination('source', dataToDisplay.length, sourceCurrentPage);
}
   
    function displayExcludedData() {
        const tableBody = document.getElementById('excludedTableBody'); let dataToDisplay = getFilteredExcludedData(); updateTableCount('excluded', dataToDisplay.length);
        if (dataToDisplay.length === 0) { renderEmptyRow(tableBody, 7); renderPagination('excluded', 0, 1); return; }
        sortData(dataToDisplay, 'excluded'); updateSortIndicators('excluded'); const paginatedData = dataToDisplay.slice((excludedCurrentPage - 1) * rowsPerPage, excludedCurrentPage * rowsPerPage); tableBody.innerHTML = '';
        paginatedData.forEach(row => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="col-action"><button class="btn-warning btn-move" onclick="moveSingleItem('${row.id}', 'excluded', 'source')" title="Hoàn tác"><i class="fas fa-undo"></i></button></td><td>${row.sourceFile.toUpperCase()}</td><td>${row['MTĐ']}</td><td>${row.MST}</td><td>${row['MÃ LOẠI TĐ']}</td><td>${row['MÃ LỖI']}</td><td>${row['MÔ TẢ LỖI']}</td>`; tableBody.appendChild(tr); });
        renderPagination('excluded', dataToDisplay.length, excludedCurrentPage);
    }

    function displayExportData() {
        const tableBody = document.getElementById('exportTableBody'); let dataToDisplay = getFilteredExportData(); updateTableCount('export', dataToDisplay.length);
        document.getElementById('bulkEditBtn').disabled = selectedExportRowIds.size === 0;
        if (dataToDisplay.length === 0) { renderEmptyRow(tableBody, 11); renderPagination('export', 0, 1); return; }
        sortData(dataToDisplay, 'export'); updateSortIndicators('export'); const paginatedData = dataToDisplay.slice((exportCurrentPage - 1) * rowsPerPage, exportCurrentPage * rowsPerPage); tableBody.innerHTML = '';
        paginatedData.forEach(row => { 
            const isChecked = selectedExportRowIds.has(row.id) ? 'checked' : ''; 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `
                <td class="col-action">
                    <input type="checkbox" class="row-checkbox" data-table="export" data-row-id="${row.id}" ${isChecked}>
                    <button class="btn-danger" onclick="moveSingleItem('${row.id}', 'export', 'source')" title="Hoàn tác"><i class="fas fa-undo"></i></button>
                </td>
                <td>${row.TVAN}</td>
                <td>${row['MTĐ']}</td>
                <td>${row['MÃ LOẠI TĐ']}</td>
                <td>${row['MÃ LỖI']}</td>
                <td class="editable" data-row-id="${row.id}" data-column-key="MÔ TẢ LỖI">${row['MÔ TẢ LỖI']}</td>
                <td>${row.TIMELOG}</td>
                <td>${row['GỬI LẦN']}</td>
                <td class="editable" data-row-id="${row.id}" data-column-key="MST">${row.MST}</td>
                <td class="editable" data-row-id="${row.id}" data-column-key="MẪU SỐ KÝ HIỆU">${row['MẪU SỐ KÝ HIỆU']}</td>
                <td class="editable" data-row-id="${row.id}" data-column-key="SỐ HĐ">${row['SỐ HĐ']}</td>`; 
            tableBody.appendChild(tr); 
        });
        renderPagination('export', dataToDisplay.length, exportCurrentPage);
    }

    function renderPagination(tablePrefix, totalRows, currentPage) {
        const paginationControls = document.getElementById(`${tablePrefix}Pagination`); if (!paginationControls) return; 
        if (totalRows <= rowsPerPage) { paginationControls.style.display = 'none'; return; }
        const pageInfo = document.getElementById(`${tablePrefix}PaginationInfo`); const prevBtn = document.getElementById(`${tablePrefix}PrevPageBtn`); const nextBtn = document.getElementById(`${tablePrefix}NextPageBtn`); const pageInput = document.getElementById(`${tablePrefix}PageInput`); const totalPages = Math.ceil(totalRows / rowsPerPage);
        paginationControls.style.display = 'flex'; pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`; pageInput.max = totalPages; prevBtn.disabled = currentPage === 1; nextBtn.disabled = currentPage >= totalPages;
    }
    
    function goToPage(tablePrefix) {
        const pageInput = document.getElementById(`${tablePrefix}PageInput`);
        const dataArray = (tablePrefix === 'source') ? getFilteredSourceData() : (tablePrefix === 'excluded') ? getFilteredExcludedData() : getFilteredExportData();
        const totalPages = Math.ceil(dataArray.length / rowsPerPage);
        let targetPage = parseInt(pageInput.value, 10);
        if (isNaN(targetPage) || targetPage < 1) targetPage = 1;
        else if (targetPage > totalPages) targetPage = totalPages;
        if (tablePrefix === 'source') { sourceCurrentPage = targetPage; displaySourceData(); } 
        else if (tablePrefix === 'excluded') { excludedCurrentPage = targetPage; displayExcludedData(); } 
        else if (tablePrefix === 'export') { exportCurrentPage = targetPage; displayExportData(); }
        pageInput.value = '';
    }

    function changePage(tablePrefix, direction) { if (tablePrefix === 'source') { sourceCurrentPage += direction; displaySourceData(); } else if (tablePrefix === 'excluded') { excludedCurrentPage += direction; displayExcludedData(); } else if (tablePrefix === 'export') { exportCurrentPage += direction; displayExportData(); } }
    function moveSelectedFromSourceToExport() { if (selectedSourceRowIds.size === 0) { showMessage('uploadMessage', 'Vui lòng chọn ít nhất một dòng.', 'warning'); return; } let movedCount = 0; dataStores.source.data = dataStores.source.data.filter(row => { if (selectedSourceRowIds.has(row.id)) { dataStores.export.data.push(row); movedCount++; return false; } return true; }); if (movedCount > 0) { selectedSourceRowIds.clear(); displayAllTables(); updateChartView(); showMessage('uploadMessage', `Đã chuyển ${movedCount} mục sang bảng kết xuất.`, 'success'); } }
    function moveSingleItem(rowId, fromTable, toTable) { const fromArray = dataStores[fromTable].data; const toArray = dataStores[toTable].data; const indexToMove = fromArray.findIndex(r => r.id === rowId); if (indexToMove > -1) { const [row] = fromArray.splice(indexToMove, 1); toArray.push(row); if (fromTable === 'source') selectedSourceRowIds.delete(rowId); if (fromTable === 'export') selectedExportRowIds.delete(rowId); if (toTable === 'source') sourceCurrentPage = 1; if (toTable === 'export') exportCurrentPage = 1; if (toTable === 'excluded') excludedCurrentPage = 1; displayAllTables(); updateChartView(); } }
    function makeCellEditable(cell) { if (cell.querySelector('input')) return; const originalValue = cell.textContent; const rowId = cell.dataset.rowId; const columnKey = cell.dataset.columnKey; cell.innerHTML = `<input type="text" value="${originalValue}" class="edit-in-place">`; const input = cell.querySelector('input'); input.focus(); input.select(); const save = () => { const newValue = input.value; cell.textContent = newValue; const rowIndex = dataStores.export.data.findIndex(r => r.id === rowId); if (rowIndex > -1) { dataStores.export.data[rowIndex][columnKey] = newValue; } }; input.addEventListener('blur', save, { once: true }); input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); else if (e.key === 'Escape') { input.removeEventListener('blur', save); cell.textContent = originalValue; } }); }
    function getFilteredData(dataArray, filterIds) { const nguon = document.getElementById(filterIds.nguon).value; const maLoaiTD = document.getElementById(filterIds.maLoaiTD).value; const maLoi = document.getElementById(filterIds.maLoi).value; const moTaLoiSearch = document.getElementById(filterIds.moTaLoi).value.toLowerCase().trim(); return dataArray.filter(row => { const isMaLoiMatch = () => (maLoi === '') || (maLoi === '_UNDEFINED_' ? row['MÃ LỖI'] === '' : row['MÃ LỖI'] === maLoi); const isMoTaLoiMatch = () => (moTaLoiSearch === '') || row['MÔ TẢ LỖI'].toLowerCase().includes(moTaLoiSearch); return (!nguon || row.sourceFile === nguon) && (!maLoaiTD || row['MÃ LOẠI TĐ'] === maLoaiTD) && isMaLoiMatch() && isMoTaLoiMatch(); }); }
    function getFilteredSourceData() { return getFilteredData(dataStores.source.data, { nguon: 'filterNguon', maLoaiTD: 'filterMaLoaiTD', maLoi: 'filterMaLoi', moTaLoi: 'filterMoTaLoi' }); }
    function getFilteredExcludedData() { return getFilteredData(dataStores.excluded.data, { nguon: 'filterExcludedNguon', maLoaiTD: 'filterExcludedMaLoaiTD', maLoi: 'filterExcludedMaLoi', moTaLoi: 'filterExcludedMoTaLoi' }); }
    function getFilteredExportData() { return getFilteredData(dataStores.export.data, { nguon: 'filterExportNguon', maLoaiTD: 'filterExportMaLoaiTD', maLoi: 'filterExportMaLoi', moTaLoi: 'filterExportMoTaLoi' }); }
    function populateFilters() { const allData = initialSourceDataForChart; const maLoaiTDOptions = new Set(allData.map(row => row['MÃ LOẠI TĐ']).filter(Boolean)); const maLoiOptions = new Set(allData.map(row => row['MÃ LỖI']).filter(Boolean)); const hasUndefinedErrors = allData.some(row => !row['MÃ LỖI']); let maLoaiTD_html = '<option value="">Tất cả</option>' + [...maLoaiTDOptions].sort((a,b) => a.localeCompare(b,'vi')).map(val => `<option value="${val}">${val}</option>`).join(''); let maLoi_html = '<option value="">Tất cả</option>'; if (hasUndefinedErrors) { maLoi_html += '<option value="_UNDEFINED_">Lỗi không xác định</option>'; } maLoi_html += [...maLoiOptions].sort((a,b) => a.localeCompare(b,'vi')).map(val => `<option value="${val}">${val}</option>`).join(''); ['filterMaLoaiTD', 'filterExcludedMaLoaiTD', 'filterExportMaLoaiTD'].forEach(id => document.getElementById(id).innerHTML = maLoaiTD_html); ['filterMaLoi', 'filterExcludedMaLoi', 'filterExportMaLoi'].forEach(id => document.getElementById(id).innerHTML = maLoi_html); }
    function handleSort(tableName, column) { const sortState = dataStores[tableName].sortState; if (!sortState) return; if (sortState.column === column) { sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; } else { sortState.column = column; sortState.direction = 'asc'; } if (tableName === 'source') displaySourceData(); else if (tableName === 'excluded') displayExcludedData(); else if (tableName === 'export') displayExportData(); }
    function sortData(dataArray, tableName) { const sortState = dataStores[tableName].sortState; if (!sortState || !sortState.column) return; dataArray.sort((a, b) => { const valA = String(a[sortState.column] || ''); const valB = String(b[sortState.column] || ''); const comparison = valA.localeCompare(valB, 'vi', { numeric: true, sensitivity: 'base' }); return sortState.direction === 'asc' ? comparison : -comparison; }); }
    function updateSortIndicators(tableName) { const sortState = dataStores[tableName].sortState; if (!sortState) { return; } document.querySelectorAll(`#${tableName}DataTable .sort-indicator`).forEach(el => el.textContent = ''); if (sortState.column) { const indicatorEl = document.getElementById(`sort-${tableName}-${sortState.column}`); if (indicatorEl) indicatorEl.textContent = sortState.direction === 'asc' ? '▲' : '▼'; } }
    function exportToExcel() { hideAllMessages(); if (dataStores.export.data.length === 0) { showMessage('exportMessage', 'Không có dữ liệu để kết xuất.', 'warning'); return; } showMessage('exportMessage', 'Đang tạo file Excel từ toàn bộ ' + dataStores.export.data.length + ' dòng...', 'info'); try { const fileName = `Tvan_Bkav_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '')}.xlsx`; const dataForSheet = dataStores.export.data.map(({ id, sourceFile, DATE_OBJECT, ...rest }) => rest); const headerOrder = ["TVAN", "MTĐ", "MÃ LOẠI TĐ", "MÃ LỖI", "MÔ TẢ LỖI", "TIMELOG", "GỬI LẦN", "MST", "MẪU SỐ KÝ HIỆU", "SỐ HĐ"]; const worksheet = XLSX.utils.json_to_sheet(dataForSheet, { header: headerOrder }); worksheet['!cols'] = [ { wch: 10 }, { wch: 35 }, { wch: 12 }, { wch: 8 }, { wch: 50 }, { wch: 12 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 10 } ]; const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'KetQuaDoiSoat'); XLSX.writeFile(workbook, fileName); showMessage('exportMessage', `Kết xuất thành công file: ${fileName}`, 'success'); } catch (error) { showMessage('exportMessage', `Lỗi kết xuất Excel: ${error.message}`, 'error'); } }
    
    // ====================================================
    // NEW/UPDATED FUNCTIONS FOR RULE MANAGEMENT
    // ====================================================
    
    // Displays all rules from the `firebaseRules` array in the modal's table
    function displayFirebaseRules() {
        const tableBody = document.getElementById('rulesTableBody');
        const countSpan = document.getElementById('rulesCount');
        if (!tableBody || !countSpan) return;

        tableBody.innerHTML = '';
        countSpan.textContent = firebaseRules.length;

        if (firebaseRules.length === 0) {
            renderEmptyRow(tableBody, 7);
            return;
        }

        firebaseRules.sort((a, b) => (a.ma_loai_td || '').localeCompare(b.ma_loai_td || ''))
            .forEach(rule => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="col-action">
                        <button class="btn-warning btn-move" onclick="populateRuleFormForEdit('${rule.key}')" title="Sửa quy tắc này"><i class="fas fa-pencil-alt"></i></button>
                        <button class="btn-danger btn-move" onclick="deleteRule('${rule.key}')" title="Xóa quy tắc này"><i class="fas fa-trash"></i></button>
                    </td>
                    <td>${rule.rule_action || ''}</td>
                    <td>${rule.ma_loai_td || ''}</td>
                    <td>${rule.ma_loi || ''}</td>
                    <td>${rule.match_type || ''}</td>
                    <td style="white-space: normal; max-width: 200px; word-break: break-word;">${rule.match_value || ''}</td>
                    <td style="white-space: normal; max-width: 200px; word-break: break-word;">${rule.standard_value || ''}</td>
                `;
                tableBody.appendChild(tr);
            });
    }

    // Fills the form with data from a rule to be edited
    function populateRuleFormForEdit(ruleKey) {
        const rule = firebaseRules.find(r => r.key === ruleKey);
        if (!rule) return;

        document.getElementById('editingRuleKey').value = rule.key;
        document.getElementById('newRuleAction').value = rule.rule_action;
        document.getElementById('newMaTD').value = rule.ma_loai_td;
        document.getElementById('newMaLoi').value = rule.ma_loi;
        document.getElementById('newMatchType').value = rule.match_type;
        document.getElementById('newMatchValue').value = rule.match_value;
        document.getElementById('newStandardValue').value = rule.standard_value || '';
        
        document.getElementById('standardValueGroup').style.display = rule.rule_action === 'STANDARDIZE' ? 'block' : 'none';
        document.getElementById('clearRuleFormBtn').style.display = 'inline-block';
        document.querySelector('#ruleManagementModal .modal-content').scrollTop = 0;
    }

    // Clears the rule form and resets it to "add new" mode
    function clearRuleForm() {
        document.getElementById('editingRuleKey').value = '';
        document.getElementById('newRuleAction').value = 'INCLUDE';
        document.getElementById('newMaTD').value = '';
        document.getElementById('newMaLoi').value = '';
        document.getElementById('newMatchType').value = 'EXACT';
        document.getElementById('newMatchValue').value = '';
        document.getElementById('newStandardValue').value = '';
        document.getElementById('standardValueGroup').style.display = 'none';
        document.getElementById('clearRuleFormBtn').style.display = 'none';
        hideAllMessages();
    }

    // Deletes a rule from Firebase
    async function deleteRule(ruleKey) {
        if (!db || !ruleKey) return;
        showLoader(true);
        try {
            await db.ref('error_definitions/' + ruleKey).remove();
            showMessage('firebaseMessage', 'Đã xóa quy tắc thành công!', 'success');
            await fetchFirebaseErrors();
            displayFirebaseRules();
        } catch (error) {
            showMessage('firebaseMessage', `Lỗi khi xóa quy tắc: ${error.message}`, 'error');
        } finally {
            showLoader(false);
        }
    }

    // Saves a new rule or updates an existing one
    async function saveRule() {
        hideAllMessages();
        const editingKey = document.getElementById('editingRuleKey').value;

        const ruleData = {
            rule_action: document.getElementById('newRuleAction').value,
            ma_loai_td: document.getElementById('newMaTD').value.trim(),
            ma_loi: document.getElementById('newMaLoi').value.trim(),
            match_type: document.getElementById('newMatchType').value,
            match_value: document.getElementById('newMatchValue').value.trim(),
            standard_value: document.getElementById('newRuleAction').value === 'STANDARDIZE' ? document.getElementById('newStandardValue').value.trim() : ''
        };

        const isFilterAction = ruleData.rule_action === 'INCLUDE' || ruleData.rule_action === 'EXCLUDE';
        if (!ruleData.ma_loai_td || !ruleData.match_value || (isFilterAction && !ruleData.ma_loi) || (ruleData.rule_action === 'STANDARDIZE' && !ruleData.standard_value)) {
            showMessage('firebaseMessage', 'Vui lòng điền các trường bắt buộc.', 'error');
            return;
        }
        
        showLoader(true);
        try {
            if (editingKey) {
                await db.ref('error_definitions/' + editingKey).update(ruleData);
                showMessage('firebaseMessage', 'Cập nhật quy tắc thành công! Xử lý lại file để áp dụng thay đổi.', 'success');
            } else {
                await db.ref('error_definitions').push(ruleData);
                showMessage('firebaseMessage', 'Lưu quy tắc mới thành công!', 'success');
            }
            clearRuleForm();
            await fetchFirebaseErrors();
            displayFirebaseRules();

        } catch (error) {
            showMessage('firebaseMessage', `Lỗi khi lưu: ${error.message}`, 'error');
        } finally {
            showLoader(false);
        }
    }

    function updateChartView() { const selectedModeEl = document.querySelector('input[name="chartViewMode"]:checked'); if (!selectedModeEl) return; renderErrorChart(selectedModeEl.value === 'remaining' ? dataStores.source.data : initialSourceDataForChart); }
    function renderErrorChart(sourceData) { if (typeof Chart === 'undefined' || sourceData.length === 0) { document.getElementById('errorChartSection').style.display = 'none'; return; } document.getElementById('errorChartSection').style.display = 'block'; const ctx = document.getElementById('errorChart').getContext('2d'); if (myErrorChart) myErrorChart.destroy(); const errorCounts = sourceData.reduce((acc, row) => { const errorCode = row['MÃ LỖI'].trim() || 'Không xác định'; acc[errorCode] = (acc[errorCode] || 0) + 1; return acc; }, {}); const sortedErrors = Object.entries(errorCounts).sort(([, a], [, b]) => b - a).slice(0, 15); const labels = sortedErrors.map(item => `Lỗi ${item[0]}`); const data = sortedErrors.map(item => item[1]); myErrorChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Số lần xuất hiện', data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim() }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { display: false } } } }); }

    // --- DOMContentLoaded EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        ['MT', 'LOI'].forEach(type => { const dropZone = document.getElementById(`dropZone${type}`), fileInput = document.getElementById(`file${type}`), fileNameSpan = document.getElementById(`fileName${type}`); if (!dropZone) return; const updateFileDisplay = (files) => { fileNameSpan.textContent = files.length > 0 ? `${files.length} tệp đã được chọn` : 'Chưa có file nào được chọn'; }; dropZone.addEventListener('click', () => fileInput.click()); fileInput.addEventListener('change', () => updateFileDisplay(fileInput.files)); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); }); dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover')); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; updateFileDisplay(fileInput.files); } }); });
        document.getElementById('exportTableBody')?.addEventListener('dblclick', (event) => { const cell = event.target.closest('td.editable'); if (cell) makeCellEditable(cell); });
        
        document.querySelectorAll('.toggle-filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        });
        
        document.getElementById('newRuleAction')?.addEventListener('change', function() { document.getElementById('standardValueGroup').style.display = this.value === 'STANDARDIZE' ? 'block' : 'none'; });
        document.querySelectorAll('input[name="chartViewMode"]').forEach(radio => radio.addEventListener('change', updateChartView));

        const debouncedFilterSource = debounce(() => { sourceCurrentPage = 1; displaySourceData(); }, 350);
        ['filterNguon', 'filterMaLoaiTD', 'filterMaLoi'].forEach(id => document.getElementById(id).addEventListener('change', debouncedFilterSource));
        document.getElementById('filterMoTaLoi').addEventListener('input', debouncedFilterSource);
        const debouncedFilterExcluded = debounce(() => { excludedCurrentPage = 1; displayExcludedData(); }, 350);
        ['filterExcludedNguon', 'filterExcludedMaLoaiTD', 'filterExcludedMaLoi'].forEach(id => document.getElementById(id).addEventListener('change', debouncedFilterExcluded));
        document.getElementById('filterExcludedMoTaLoi').addEventListener('input', debouncedFilterExcluded);
        const debouncedFilterExport = debounce(() => { exportCurrentPage = 1; displayExportData(); }, 350);
        ['filterExportNguon', 'filterExportMaLoaiTD', 'filterExportMaLoi'].forEach(id => document.getElementById(id).addEventListener('change', debouncedFilterExport));
        document.getElementById('filterExportMoTaLoi').addEventListener('input', debouncedFilterExport);

        ['source', 'excluded', 'export'].forEach(prefix => {
            document.getElementById(`${prefix}PrevPageBtn`).addEventListener('click', () => changePage(prefix, -1));
            document.getElementById(`${prefix}NextPageBtn`).addEventListener('click', () => changePage(prefix, 1));
            document.getElementById(`${prefix}GoBtn`).addEventListener('click', () => goToPage(prefix));
            document.getElementById(`${prefix}PageInput`).addEventListener('keydown', (e) => { if (e.key === 'Enter') goToPage(prefix); });
        });
        
        document.getElementById('sourceTableBody').addEventListener('change', (e) => { 
            if (e.target.matches('#selectAllSource')) {
                const isChecked = e.target.checked;
                const filteredData = getFilteredSourceData();
                const filteredIds = new Set(filteredData.map(r => r.id));
                
                document.querySelectorAll('#sourceTableBody .row-checkbox').forEach(checkbox => {
                    if (filteredIds.has(checkbox.dataset.rowId)) {
                        checkbox.checked = isChecked;
                        if (isChecked) {
                            selectedSourceRowIds.add(checkbox.dataset.rowId);
                        } else {
                            selectedSourceRowIds.delete(checkbox.dataset.rowId);
                        }
                    }
                });
            } else if (e.target.classList.contains('row-checkbox') && e.target.dataset.table === 'source') {
                const rowId = e.target.dataset.rowId;
                if (e.target.checked) selectedSourceRowIds.add(rowId);
                else selectedSourceRowIds.delete(rowId);
            }
        });

        document.getElementById('exportTableBody').addEventListener('change', (e) => {
            if (e.target.matches('#selectAllExport')) {
                 const isChecked = e.target.checked;
                const filteredData = getFilteredExportData();
                filteredData.forEach(row => {
                    if(isChecked) selectedExportRowIds.add(row.id);
                    else selectedExportRowIds.delete(row.id);
                });
                displayExportData();
            } else if (e.target.classList.contains('row-checkbox') && e.target.dataset.table === 'export') {
                const rowId = e.target.dataset.rowId;
                if (e.target.checked) selectedExportRowIds.add(rowId);
                else selectedExportRowIds.delete(rowId);
                document.getElementById('bulkEditBtn').disabled = selectedExportRowIds.size === 0;
            }
        });

        document.getElementById('bulkEditBtn').addEventListener('click', () => { if (selectedExportRowIds.size > 0) { document.getElementById('bulkEditTitle').textContent = `Sửa hàng loạt cho ${selectedExportRowIds.size} mục đã chọn`; document.getElementById('bulkEditModal').style.display = 'block'; } });
        document.getElementById('bulkEditCloseBtn').addEventListener('click', () => document.getElementById('bulkEditModal').style.display = 'none');
        document.getElementById('saveBulkEditBtn').addEventListener('click', () => {
            const column = document.getElementById('bulkEditColumn').value;
            const value = document.getElementById('bulkEditValue').value;
            dataStores.export.data.forEach(row => { if (selectedExportRowIds.has(row.id)) row[column] = value; });
            document.getElementById('bulkEditModal').style.display = 'none';
            selectedExportRowIds.clear();
            displayExportData();
            showMessage('uploadMessage', `Đã cập nhật hàng loạt cột "${column}" thành công.`, 'success');
        });

        document.getElementById('alertsContainer').addEventListener('click', (e) => {
            if (e.target.classList.contains('view-chart-link')) {
                const errorCode = e.target.dataset.errorCode;
                displayTrendChart(errorCode);
            }
        });
        document.getElementById('trendChartCloseBtn').addEventListener('click', () => document.getElementById('trendChartModal').style.display = 'none');
        
        // --- Event listeners for Rule Management Modal ---
        document.getElementById('openRuleMgmtBtn').addEventListener('click', async () => {
            showLoader(true);
            await fetchFirebaseErrors();
            displayFirebaseRules();
            showLoader(false);
            document.getElementById('ruleManagementModal').style.display = 'block';
        });
        document.getElementById('ruleMgmtCloseBtn').addEventListener('click', () => document.getElementById('ruleManagementModal').style.display = 'none');
        document.getElementById('saveRuleBtn').addEventListener('click', saveRule);
        document.getElementById('clearRuleFormBtn').addEventListener('click', clearRuleForm);

        window.addEventListener('click', (e) => { 
            if (e.target == document.getElementById('bulkEditModal')) document.getElementById('bulkEditModal').style.display = "none";
            if (e.target == document.getElementById('trendChartModal')) document.getElementById('trendChartModal').style.display = "none";
            if (e.target == document.getElementById('ruleManagementModal')) document.getElementById('ruleManagementModal').style.display = "none";
        });
    });
</script>
</body>
</html>
