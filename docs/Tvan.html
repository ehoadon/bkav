<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Đối soát lỗi TVAN</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --light-color: #f8f9fa;
            --dark-color: #343a40; --white-color: #fff; --border-color: #dee2e6;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); --border-radius: 8px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--light-color); color: var(--dark-color); }
        .container { max-width: 1600px; margin: 20px auto; background: var(--white-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        h2, h3, h4 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 0; }
        h4 { border-bottom: none; color: var(--dark-color); }
        .section { background-color: #fdfdff; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 25px; }
        button { padding: 10px 20px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease, transform 0.1s ease; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.7; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--danger-color); padding: 5px 10px; font-size: 14px; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-warning { background-color: var(--warning-color); color: #212529; padding: 5px 10px; font-size: 14px; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-move { padding: 5px 10px; font-size: 14px; }
        input, select { padding: 10px; margin: 5px 0 15px 0; border-radius: 5px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; }
        .input-group { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
        .input-group > * { flex: 1 1 250px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        .table-wrapper { overflow: auto; max-height: 400px; }
        th, td { border: 1px solid var(--border-color); padding: 10px; text-align: left; vertical-align: middle; white-space: nowrap; }
        th { background-color: var(--primary-color); color: var(--white-color); position: sticky; top: 0; z-index: 1; }
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #0069d9; }
        .sort-indicator { margin-left: 5px; font-size: 0.8em; display: inline-block; width: 10px; }
        td.col-action { text-align: center; }
        th.col-action { background-color: #6c757d; text-align: center; }
        td.editable { background-color: #fffbe6; cursor: text; }
        .edit-in-place { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--primary-color); }
        .message { padding: 15px; border-radius: 5px; margin-top: 15px; font-weight: 500; display: none; }
        #loader { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); justify-content: center; align-items: center; }
        .spinner { border: 8px solid var(--light-color); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible { background-color: #f1f1f1; cursor: pointer; padding: 12px; width: 100%; border: none; text-align: left; outline: none; font-size: 18px; margin-top: 20px; border-radius: 5px; }
        .collapsible:hover { background-color: #e2e2e2; }
        .collapsible:after { content: '\\002B'; color: var(--secondary-color); font-weight: bold; float: right; margin-left: 5px; }
        .collapsible.active:after { content: "\\2212"; }
        .content { padding: 20px; display: none; overflow: hidden; border: 1px solid var(--border-color); border-top: none; }
        .drop-zones-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .drop-zone { flex: 1; border: 2px dashed var(--border-color); border-radius: var(--border-radius); padding: 30px; text-align: center; color: var(--secondary-color); transition: background-color 0.3s ease, border-color 0.3s ease; cursor: pointer; }
        .drop-zone.dragover { background-color: #e9ecef; border-color: var(--primary-color); }
        .file-name { font-weight: bold; color: var(--dark-color); display: block; margin-top: 10px; word-break: break-all; }
        #standardValueGroup { display: none; }
        .chart-options { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; align-items: center; }
        .chart-options label { cursor: pointer; font-weight: 500; }
        .chart-options input { width: auto; margin-right: 5px; }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <div class="container">
        <header> <h2>Công cụ Đối soát lỗi TVAN</h2> </header>
        <main>
            <section class="section">
                <h3>Bước 1: Tải lên File Dữ liệu</h3>
                <div class="drop-zones-container">
                    <div class="drop-zone" id="dropZoneMT"><label for="fileMT"><b>Khu vực File MT</b></label><p>Kéo thả hoặc nhấn để chọn file</p><span class="file-name" id="fileNameMT">Chưa có file nào được chọn</span><input type="file" id="fileMT" accept=".xls,.xlsx" style="display:none;"></div>
                    <div class="drop-zone" id="dropZoneLOI"><label for="fileLOI"><b>Khu vực File LOI</b></label><p>Kéo thả hoặc nhấn để chọn file</p><span class="file-name" id="fileNameLOI">Chưa có file nào được chọn</span><input type="file" id="fileLOI" accept=".xls,.xlsx" style="display:none;"></div>
                </div>
                <button onclick="handleFileUpload()" id="processBtn" class="btn-success">Xử lý & Đối soát</button>
                <div id="uploadMessage" class="message"></div>
            </section>
            
            <section class="section" id="chartSection" style="display:none;">
                <h3>Thống kê Lỗi</h3>
                <div class="chart-options">
                    <label><input type="radio" name="chartViewMode" id="viewModeRemaining" value="remaining" checked> Công việc còn lại</label>
                    <label><input type="radio" name="chartViewMode" id="viewModeInitial" value="initial"> Tổng quan ban đầu</label>
                </div>
                <div style="position: relative; width: 90%; max-width: 900px; margin: auto; padding: 20px; border: 1px solid var(--border-color); border-radius: var(--border-radius);"><canvas id="errorChart"></canvas></div>
            </section>
            
            <section class="section" id="processingSection" style="display:none;">
                <h3>Bước 2: Sàng lọc dữ liệu</h3>
                
                <div id="sourceTableSection">
                    <h4>Bảng 1: Dữ liệu cần xử lý thủ công (<span id="sourceCount">0</span>)</h4>
                    <div class="input-group">
                        <div> <label for="filterNguon">Lọc theo Nguồn:</label> <select id="filterNguon" onchange="displaySourceData()"> <option value="">Tất cả</option><option value="MT">MT</option><option value="LOI">LOI</option> </select> </div>
                        <div> <label for="filterMaLoaiTD">Lọc theo Mã Loại TĐ:</label> <select id="filterMaLoaiTD" onchange="displaySourceData()"></select> </div>
                        <div> <label for="filterMaLoi">Lọc theo Mã Lỗi:</label> <select id="filterMaLoi" onchange="displaySourceData()"></select> </div>
                        <button onclick="moveSelectedFromSourceToExport()">Chuyển mục đã chọn sang Bảng 3</button>
                    </div>
                    <div class="table-wrapper"><table id="sourceDataTable"><thead><tr><th class="col-action"><input type="checkbox" id="selectAllSource" title="Chọn/Bỏ chọn tất cả"></th><th class="col-action">Hành động</th><th class="sortable-header" onclick="handleSort('source', 'sourceFile')">Nguồn<span id="sort-source-sourceFile" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MTĐ')">MTĐ<span id="sort-source-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MST')">MST<span id="sort-source-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-source-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÃ LỖI')">MÃ LỖI<span id="sort-source-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('source', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-source-MÔ TẢ LỖI" class="sort-indicator"></span></th></tr></thead><tbody id="sourceTableBody"></tbody></table></div>
                </div>
                <hr style="margin: 40px 0;">

                <div id="excludedTableSection">
                    <h4 class="collapsible">Bảng 2: Dữ liệu đã loại trừ tự động (<span id="excludedCount">0</span>)</h4>
                    <div class="content">
                        <div class="table-wrapper"><table id="excludedDataTable"><thead><tr><th class="col-action">Hành động</th><th class="sortable-header" onclick="handleSort('excluded', 'sourceFile')">Nguồn<span id="sort-excluded-sourceFile" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MTĐ')">MTĐ<span id="sort-excluded-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MST')">MST<span id="sort-excluded-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-excluded-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÃ LỖI')">MÃ LỖI<span id="sort-excluded-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('excluded', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-excluded-MÔ TẢ LỖI" class="sort-indicator"></span></th></tr></thead><tbody id="excludedTableBody"></tbody></table></div>
                    </div>
                </div>
                <hr style="margin: 40px 0;">

                <div id="exportTableSection">
                    <h4>Bảng 3: Dữ liệu đã xử lý để kết xuất (<span id="exportCount">0</span>)</h4>
                    <div class="table-wrapper"><table id="exportDataTable"><thead><tr><th class="col-action">Hành động</th><th class="sortable-header" onclick="handleSort('export', 'TVAN')">TVAN<span id="sort-export-TVAN" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MTĐ')">MTĐ<span id="sort-export-MTĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÃ LOẠI TĐ')">MÃ LOẠI TĐ<span id="sort-export-MÃ LOẠI TĐ" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÃ LỖI')">MÃ LỖI<span id="sort-export-MÃ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MÔ TẢ LỖI')">MÔ TẢ LỖI<span id="sort-export-MÔ TẢ LỖI" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'TIMELOG')">TIMELOG<span id="sort-export-TIMELOG" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'GỬI LẦN')">GỬI LẦN<span id="sort-export-GỬI LẦN" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MST')">MST<span id="sort-export-MST" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'MẪU SỐ KÝ HIỆU')">MẪU SỐ KÝ HIỆU<span id="sort-export-MẪU SỐ KÝ HIỆU" class="sort-indicator"></span></th><th class="sortable-header" onclick="handleSort('export', 'SỐ HĐ')">SỐ HĐ<span id="sort-export-SỐ HĐ" class="sort-indicator"></span></th></tr></thead><tbody id="exportTableBody"></tbody></table></div>
                </div>
            </section>
            
            <section class="section" id="exportActionSection" style="display:none;">
                <h3>Bước 3: Kết xuất kết quả</h3>
                <button onclick="exportToExcel()" id="exportBtn" class="btn-success">Kết xuất Bảng 3 ra Excel</button>
                <div id="exportMessage" class="message"></div>
            </section>
            
            <button type="button" class="collapsible">Quản lý Quy tắc Đối soát trên Firebase</button>
            <div class="content">
                <h3>Thêm/Cập nhật quy tắc</h3>
                <div class="input-group">
                    <div><label for="newRuleAction">Hành động của Quy tắc:</label><select id="newRuleAction"><option value="INCLUDE">Bao gồm (Lấy vào bảng kết xuất)</option><option value="EXCLUDE">Loại trừ (Ẩn khỏi bảng thủ công)</option><option value="STANDARDIZE">Chuẩn hóa (Ghi đè Mô tả lỗi)</option></select></div>
                    <div><label for="newMaTD">Mã Loại Thông Điệp:</label><input type="text" id="newMaTD" placeholder="Bắt buộc"></div>
                    <div><label for="newMaLoi">Mã Lỗi:</label><input type="text" id="newMaLoi" placeholder="Bắt buộc cho Lấy/Loại trừ"></div>
                </div>
                <div class="input-group">
                    <div style="flex-grow: 2;"><label for="newMatchType">Loại so sánh Mô tả lỗi:</label><select id="newMatchType"><option value="EXACT">Khớp chính xác</option><option value="CONTAINS">Chứa chuỗi ký tự</option><option value="REGEX">Biểu thức chính quy</option></select></div>
                    <div style="flex-grow: 3;"><label for="newMatchValue">Giá trị so sánh (Nội dung, từ khóa, hoặc mẫu Regex):</label><input type="text" id="newMatchValue" placeholder="Bắt buộc"></div>
                </div>
                <div id="standardValueGroup">
                     <label for="newStandardValue">Giá trị Chuẩn hóa để Ghi đè:</label>
                     <input type="text" id="newStandardValue" placeholder="Bắt buộc khi hành động là Chuẩn hóa">
                </div>
                <button onclick="addErrorToFirebase()">Lưu Quy tắc vào Firebase</button>
                <div id="firebaseMessage" class="message"></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- CONFIG & GLOBAL VARIABLES ---
    const DEBUG_MODE = false; 
    const cfg = {
        apiKey: 'AIzaSyDsdrQakeA8iZ3iVerSNRvXC9bneyzluSU',
        authDomain: 'ehoadon-bkav.firebaseapp.com',
        databaseURL: 'https://ehoadon-bkav-default-rtdb.firebaseio.com',
        projectId: 'ehoadon-bkav',
        storageBucket: 'ehoadon-bkav.appspot.com',
        messagingSenderId: '688737951508',
        appId: '1:688737951508:web:965514a6a1f7c4de15ac01'
    };
    let db = null;
    try {
        firebase.initializeApp(cfg);
        db = firebase.database();
    } catch (error) { console.error("Firebase initialization error:", error); alert("Không thể kết nối tới Firebase."); }

    let firebaseRules = []; 
    let myErrorChart = null;
    let initialSourceDataForChart = [];

    const dataStores = {
        source: { data: [], sortState: { column: null, direction: 'asc' } },
        export: { data: [], sortState: { column: null, direction: 'asc' } },
        excluded: { data: [], sortState: { column: null, direction: 'asc' } }
    };
    
    // --- UTILITY FUNCTIONS ---
    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
    function showMessage(elementId, text, type = 'status') {
        const el = document.getElementById(elementId);
        if(el) { el.textContent = text; el.className = `message ${type}-message`; el.style.display = 'block'; }
    }
    function hideAllMessages() {
        document.querySelectorAll('.message').forEach(msg => msg.style.display = 'none');
    }

    function readExcel(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    if (!worksheet) { resolve([]); return; }
                    resolve(XLSX.utils.sheet_to_json(worksheet));
                } catch (error) { reject(error); }
            };
            reader.onerror = () => reject(new Error("Lỗi không thể đọc file."));
            reader.readAsArrayBuffer(file);
        });
    }
    function formatDate(dateInput) {
        if (!dateInput) return '';
        let d = (dateInput instanceof Date && !isNaN(dateInput)) ? dateInput : new Date(dateInput);
        if (!isNaN(d)) { return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`; }
        return String(dateInput);
    }

    // --- CORE RECONCILIATION LOGIC ---
    function isMatch(excelRow, rule) {
        const maLoaiTDMatch = excelRow['MÃ LOẠI TĐ'].toString().trim() === rule.ma_loai_td.toString().trim();
        if (!maLoaiTDMatch) return false;

        let maLoiMatch = true;
        if (rule.ma_loi) {
            maLoiMatch = excelRow['MÃ LỖI'].toString().trim() === rule.ma_loi.toString().trim();
        }
        if (!maLoiMatch) return false;

        const moTaLoi = excelRow['MÔ TẢ LỖI'].toString();
        const matchValue = rule.match_value.toString();
        switch (rule.match_type) {
            case 'EXACT': return moTaLoi.trim() === matchValue.trim();
            case 'CONTAINS': return moTaLoi.toLowerCase().includes(matchValue.toLowerCase());
            case 'REGEX':
                try {
                    const regex = new RegExp(matchValue, 'i');
                    return regex.test(moTaLoi);
                } catch (e) {
                    console.error(`Regex không hợp lệ: "${matchValue}"`, e);
                    return false;
                }
            default: return false;
        }
    }

    async function fetchFirebaseErrors() {
        if (!db) return 0;
        firebaseRules = [];
        const snapshot = await db.ref('error_definitions').get();
        if (snapshot.exists()) {
            const data = snapshot.val();
            for (const key in data) {
                const rule = data[key];
                rule.rule_action = rule.rule_action || 'INCLUDE';
                if (!rule.match_type && rule.mo_ta_loi) {
                    rule.match_type = 'EXACT';
                    rule.match_value = rule.mo_ta_loi;
                }
                firebaseRules.push(rule);
            }
        }
        if (DEBUG_MODE) { console.log(`[DEBUG] Tải ${firebaseRules.length} quy tắc từ Firebase.`, firebaseRules); }
        return firebaseRules.length;
    }

    async function handleFileUpload() {
        hideAllMessages();
        showLoader(true);
        showMessage('uploadMessage', 'Bắt đầu xử lý...', 'status');
        const fileMT = document.getElementById('fileMT').files[0];
        const fileLOI = document.getElementById('fileLOI').files[0];
        if (!fileMT || !fileLOI) {
            showMessage('uploadMessage', 'Vui lòng cung cấp cả hai file MT và LOI.', 'error');
            showLoader(false); return;
        }
        try {
            showMessage('uploadMessage', 'Đang tải quy tắc xử lý từ Firebase...', 'status');
            const rulesCount = await fetchFirebaseErrors();
            showMessage('uploadMessage', `Tải thành công ${rulesCount} quy tắc. Đang đọc file Excel...`, 'status');
            
            const [mtData, loiData] = await Promise.all([readExcel(fileMT), readExcel(fileLOI)]);
            
            showMessage('uploadMessage', 'Đang xử lý dữ liệu...', 'status');
            processDataWithRules(mtData, loiData);
            
            populateFilters();
            displayAllTables();
            
            document.getElementById('processingSection').style.display = 'block';
            document.getElementById('exportActionSection').style.display = 'block';
            
            document.getElementById('viewModeRemaining').checked = true;
            updateChartView();
            
            showMessage('uploadMessage', `Xử lý hoàn tất! Kết quả đã được phân loại vào 3 bảng.`, 'success');
        } catch (error) {
            console.error("Lỗi trong quá trình xử lý:", error);
            showMessage('uploadMessage', `Lỗi xử lý file: ${error.message}`, 'error');
        } finally {
            showLoader(false);
        }
    }

    // Thay đổi: Sửa lại logic của hàm này để tạo snapshot cho biểu đồ đúng thời điểm
    function processDataWithRules(mtData, loiData) {
        // 1. Reset các kho dữ liệu
        dataStores.source.data = [];
        dataStores.export.data = [];
        dataStores.excluded.data = [];
        initialSourceDataForChart = [];
        let idCounter = 0;
        let rawData = [];

        // 2. Gộp dữ liệu từ 2 file vào một mảng `rawData` duy nhất
        const mapRawData = (data, sourceIdentifier) => {
            if (!Array.isArray(data)) return;
            data.forEach(row => {
                const moTaLoiGoc = (row['Mô tả lỗi'] || row['MÔ TẢ LỖI'] || '').toString();
                rawData.push({ 
                    id: `row-${idCounter++}`, TVAN: 'tvan_bkav', 
                    'MTĐ': row['Mã Thông điệp'] || row['MTĐ'] || '',  
                    'MÃ LOẠI TĐ': (row['Mã loại thông điệp'] || row['MÃ LOẠI TĐ'] || '').toString().trim(), 
                    'MÃ LỖI': (row['Mã Lôi'] || row['Mã Lỗi'] || row['MÃ LỖI'] || '').toString().trim(), 
                    sourceFile: sourceIdentifier, 'MÔ TẢ LỖI': moTaLoiGoc, 
                    TIMELOG: formatDate(row['Ngày tạo'] || row['ngaytao'] || row['TIMELOG'] || row['TimeLog']), 
                    'GỬI LẦN': 1, 'MST': row['Mã số thuế'] || row['MST'] || '',  
                    'MẪU SỐ KÝ HIỆU': (moTaLoiGoc.includes(';') && moTaLoiGoc.split(';')[1]) ? `1${moTaLoiGoc.split(';')[1]}` : '',  
                    'SỐ HĐ': (moTaLoiGoc.includes(';') && moTaLoiGoc.split(';')[2]) ? moTaLoiGoc.split(';')[2] : ''
                });
            });
        };
        mapRawData(mtData, 'MT');
        mapRawData(loiData, 'LOI');

        // 3. Tách các loại quy tắc
        const standardizeRules = firebaseRules.filter(r => r.rule_action === 'STANDARDIZE');
        const filterRules = firebaseRules.filter(r => r.rule_action === 'INCLUDE' || r.rule_action === 'EXCLUDE');

        // 4. Áp dụng quy tắc Chuẩn hóa (Ghi đè) lên `rawData`
        rawData.forEach(row => {
            const matchingStandardizeRule = standardizeRules.find(rule => isMatch(row, rule));
            if (matchingStandardizeRule) {
                row['MÔ TẢ LỖI'] = matchingStandardizeRule.standard_value;
            }
        });

        // 5. LƯU DỮ LIỆU TỔNG QUAN: Tạo bản sao của TOÀN BỘ dữ liệu thô (sau khi đã chuẩn hóa) cho biểu đồ tổng quan
        initialSourceDataForChart = [...rawData];

        // 6. Áp dụng quy tắc Lọc (Lấy/Loại trừ) để phân loại dữ liệu vào các bảng
        rawData.forEach(row => {
            const matchingFilterRule = filterRules.find(rule => isMatch(row, rule));
            if (matchingFilterRule) {
                if (matchingFilterRule.rule_action === 'INCLUDE') {
                    dataStores.export.data.push(row);
                } else { 
                    dataStores.excluded.data.push(row);
                }
            } else {
                // Dữ liệu không khớp quy tắc nào sẽ vào Bảng 1 (công việc còn lại)
                dataStores.source.data.push(row);
            }
        });
    }

    // --- DISPLAY & UI INTERACTION FUNCTIONS ---
    function displayAllTables() {
        displaySourceData();
        displayExportData();
        displayExcludedData();
    }

    function updateTableCount(tableId, count) {
        document.getElementById(`${tableId}Count`).textContent = count;
    }

    function displaySourceData() {
        const tableBody = document.getElementById('sourceTableBody');
        tableBody.innerHTML = '';
        let dataToDisplay = getFilteredSourceData();
        sortData(dataToDisplay, 'source');
        updateSortIndicators('source');
        dataToDisplay.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="col-action"><input type="checkbox" data-row-id="${row.id}"></td><td class="col-action"><button class="btn-success btn-move" onclick="moveSingleItem('${row.id}', 'source', 'export')" title="Chuyển sang Bảng 2">Lấy</button></td><td>${row.sourceFile.toUpperCase()}</td><td>${row['MTĐ']}</td><td>${row.MST}</td><td>${row['MÃ LOẠI TĐ']}</td><td>${row['MÃ LỖI']}</td><td>${row['MÔ TẢ LỖI']}</td>`;
            tableBody.appendChild(tr);
        });
        updateTableCount('source', dataToDisplay.length);
    }
    
    function displayExcludedData() {
        const tableBody = document.getElementById('excludedTableBody');
        tableBody.innerHTML = '';
        sortData(dataStores.excluded.data, 'excluded');
        updateSortIndicators('excluded');
        dataStores.excluded.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="col-action"><button class="btn-warning btn-move" onclick="moveSingleItem('${row.id}', 'excluded', 'source')" title="Hoàn tác về Bảng 1">Hoàn tác</button></td><td>${row.sourceFile.toUpperCase()}</td><td>${row['MTĐ']}</td><td>${row.MST}</td><td>${row['MÃ LOẠI TĐ']}</td><td>${row['MÃ LỖI']}</td><td>${row['MÔ TẢ LỖI']}</td>`;
            tableBody.appendChild(tr);
        });
        updateTableCount('excluded', dataStores.excluded.data.length);
    }

    function displayExportData() {
        const tableBody = document.getElementById('exportTableBody');
        tableBody.innerHTML = '';
        sortData(dataStores.export.data, 'export');
        updateSortIndicators('export');
        dataStores.export.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="col-action"><button class="btn-danger" onclick="moveSingleItem('${row.id}', 'export', 'source')">Hoàn tác</button></td><td>${row.TVAN}</td><td>${row['MTĐ']}</td><td>${row['MÃ LOẠI TĐ']}</td><td>${row['MÃ LỖI']}</td><td class="editable" data-row-id="${row.id}" data-column-key="MÔ TẢ LỖI">${row['MÔ TẢ LỖI']}</td><td>${row.TIMELOG}</td><td>${row['GỬI LẦN']}</td><td class="editable" data-row-id="${row.id}" data-column-key="MST">${row.MST}</td><td class="editable" data-row-id="${row.id}" data-column-key="MẪU SỐ KÝ HIỆU">${row['MẪU SỐ KÝ HIỆU']}</td><td class="editable" data-row-id="${row.id}" data-column-key="SỐ HĐ">${row['SỐ HĐ']}</td>`;
            tableBody.appendChild(tr);
        });
        updateTableCount('export', dataStores.export.data.length);
    }

    function moveSingleItem(rowId, fromTable, toTable) {
        const fromArray = dataStores[fromTable].data;
        const toArray = dataStores[toTable].data;
        
        const indexToMove = fromArray.findIndex(r => r.id === rowId);
        if (indexToMove > -1) {
            const [row] = fromArray.splice(indexToMove, 1);
            toArray.push(row);
            displayAllTables();
            updateChartView();
        }
    }

    function moveSelectedFromSourceToExport() {
        const checkboxes = document.querySelectorAll('#sourceTableBody input[type="checkbox"]:checked');
        if (checkboxes.length === 0) { alert('Vui lòng chọn ít nhất một dòng để chuyển.'); return; }
        const rowIdsToMove = Array.from(checkboxes).map(cb => cb.dataset.rowId);
        let movedCount = 0;
        for (let i = dataStores.source.data.length - 1; i >= 0; i--) {
            if (rowIdsToMove.includes(dataStores.source.data[i].id)) {
                const [row] = dataStores.source.data.splice(i, 1);
                dataStores.export.data.push(row);
                movedCount++;
            }
        }
        if(movedCount > 0){ 
            displayAllTables();
            updateChartView();
        }
        document.getElementById('selectAllSource').checked = false;
    }
    
    function makeCellEditable(cell) {
        if (cell.querySelector('input')) return;
        const originalValue = cell.textContent;
        const rowId = cell.dataset.rowId;
        const columnKey = cell.dataset.columnKey;
        cell.innerHTML = `<input type="text" value="${originalValue}" class="edit-in-place">`;
        const input = cell.querySelector('input');
        input.focus();
        input.select();
        const save = () => {
            const newValue = input.value;
            cell.textContent = newValue;
            const rowIndex = dataStores.export.data.findIndex(r => r.id === rowId);
            if (rowIndex > -1) { dataStores.export.data[rowIndex][columnKey] = newValue; }
        };
        input.addEventListener('blur', save, { once: true });
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') input.blur();
            else if (e.key === 'Escape') { input.removeEventListener('blur', save); cell.textContent = originalValue; }
        });
    }

    function getFilteredSourceData() {
        const nguon = document.getElementById('filterNguon').value;
        const maLoaiTD = document.getElementById('filterMaLoaiTD').value;
        const maLoi = document.getElementById('filterMaLoi').value;
        return dataStores.source.data.filter(row => {
            const isMaLoiMatch = () => (maLoi === '') || (maLoi === '_UNDEFINED_' ? row['MÃ LỖI'] === '' : row['MÃ LỖI'] === maLoi);
            return (!nguon || row.sourceFile === nguon) && (!maLoaiTD || row['MÃ LOẠI TĐ'] === maLoaiTD) && isMaLoiMatch();
        });
    }

    function populateFilters() {
        // Thay đổi: Dữ liệu cho bộ lọc giờ lấy từ initialSourceDataForChart để đảm bảo đầy đủ
        const allData = initialSourceDataForChart;

        const populateSelect = (selectId, dataSet, key) => {
            const select = document.getElementById(selectId);
            const options = new Set(dataSet.map(row => row[key]).filter(Boolean));
            select.innerHTML = '<option value="">Tất cả</option>' + [...options].sort((a, b) => a.localeCompare(b, 'vi')).map(val => `<option value="${val}">${val}</option>`).join('');
        };
        populateSelect('filterMaLoaiTD', allData, 'MÃ LOẠI TĐ');

        const selectMaLoi = document.getElementById('filterMaLoi');
        const definedErrorCodes = [...new Set(allData.map(row => row['MÃ LỖI']).filter(Boolean))];
        const hasUndefinedErrors = allData.some(row => !row['MÃ LỖI']);

        let optionsHtml = '<option value="">Tất cả</option>';
        if (hasUndefinedErrors) {
            optionsHtml += '<option value="_UNDEFINED_">Lỗi không xác định</option>';
        }
        optionsHtml += definedErrorCodes.sort((a, b) => a.localeCompare(b, 'vi')).map(val => `<option value="${val}">${val}</option>`).join('');

        selectMaLoi.innerHTML = optionsHtml;
    }
    
    function handleSort(tableName, column) {
        const sortState = dataStores[tableName].sortState;
        if (!sortState) return;
        if (sortState.column === column) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = column;
            sortState.direction = 'asc';
        }
        window['display' + tableName.charAt(0).toUpperCase() + tableName.slice(1) + 'Data']();
    }
    
    function sortData(dataArray, tableName) {
        const sortState = dataStores[tableName].sortState;
        if (!sortState || !sortState.column) return;
        dataArray.sort((a, b) => {
            const valA = String(a[sortState.column] || '');
            const valB = String(b[sortState.column] || '');
            const comparison = valA.localeCompare(valB, 'vi', { numeric: true, sensitivity: 'base' });
            return sortState.direction === 'asc' ? comparison : -comparison;
        });
    }
    
    function updateSortIndicators(tableName) {
        const sortState = dataStores[tableName].sortState;
        if (!sortState) {
             console.error(`Không tìm thấy trạng thái sắp xếp cho bảng: ${tableName}`);
             return;
        }
        document.querySelectorAll(`#${tableName}DataTable .sort-indicator`).forEach(el => el.textContent = '');
        if (sortState.column) {
            const indicatorEl = document.getElementById(`sort-${tableName}-${sortState.column}`);
            if (indicatorEl) indicatorEl.textContent = sortState.direction === 'asc' ? '▲' : '▼';
        }
    }
    
    function exportToExcel() {
        hideAllMessages();
        if (dataStores.export.data.length === 0) { showMessage('exportMessage', 'Không có dữ liệu để kết xuất.', 'error'); return; }
        showMessage('exportMessage', 'Đang tạo file Excel...', 'status');
        try {
            const fileName = `Tvan_Bkav_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '')}.xlsx`;
            const dataForSheet = dataStores.export.data.map(({ id, sourceFile, ...rest }) => rest);
            const headerOrder = ["TVAN", "MTĐ", "MÃ LOẠI TĐ", "MÃ LỖI", "MÔ TẢ LỖI", "TIMELOG", "GỬI LẦN", "MST", "MẪU SỐ KÝ HIỆU", "SỐ HĐ"];
            const worksheet = XLSX.utils.json_to_sheet(dataForSheet, { header: headerOrder });
            worksheet['!cols'] = [ { wch: 10 }, { wch: 35 }, { wch: 12 }, { wch: 8 }, { wch: 50 }, { wch: 12 }, { wch: 8 }, { wch: 15 }, { wch: 15 }, { wch: 10 } ];
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'KetQuaDoiSoat');
            XLSX.writeFile(workbook, fileName);
            showMessage('exportMessage', `Kết xuất thành công file: ${fileName}`, 'success');
        } catch (error) { showMessage('exportMessage', `Lỗi kết xuất Excel: ${error.message}`, 'error'); }
    }

    async function addErrorToFirebase() {
        hideAllMessages();
        const ruleAction = document.getElementById('newRuleAction').value;
        const newRule = { 
            rule_action: ruleAction,
            ma_loai_td: document.getElementById('newMaTD').value.trim(), 
            ma_loi: document.getElementById('newMaLoi').value.trim(), 
            match_type: document.getElementById('newMatchType').value,
            match_value: document.getElementById('newMatchValue').value.trim(),
            standard_value: ruleAction === 'STANDARDIZE' ? document.getElementById('newStandardValue').value.trim() : ''
        };

        const isFilterAction = newRule.rule_action === 'INCLUDE' || newRule.rule_action === 'EXCLUDE';
        if ( !newRule.ma_loai_td || !newRule.match_value || (isFilterAction && !newRule.ma_loi) || (newRule.rule_action === 'STANDARDIZE' && !newRule.standard_value) ) {
            showMessage('firebaseMessage', 'Vui lòng điền các trường bắt buộc. "Mã lỗi" là bắt buộc cho hành động Lấy/Loại trừ.', 'error');
            return;
        }

        const uniqueKey = db.ref('error_definitions').push().key;
        try {
            await db.ref('error_definitions/' + uniqueKey).set(newRule);
            showMessage('firebaseMessage', 'Lưu quy tắc thành công! Xử lý lại file để áp dụng.', 'success');
            await fetchFirebaseErrors();
        } catch (error) {
            showMessage('firebaseMessage', `Lỗi khi lưu: ${error.message}`, 'error');
        }
    }
    
    function updateChartView() {
        const selectedModeEl = document.querySelector('input[name="chartViewMode"]:checked');
        if (!selectedModeEl) return;

        const selectedMode = selectedModeEl.value;
        if (selectedMode === 'remaining') {
            renderErrorChart(dataStores.source.data);
        } else { // 'initial'
            renderErrorChart(initialSourceDataForChart);
        }
    }

    function renderErrorChart(sourceData) {
        if (typeof Chart === 'undefined') {
            document.getElementById('chartSection').style.display = 'none';
            return;
        }
        document.getElementById('chartSection').style.display = sourceData.length > 0 ? 'block' : 'none';
        const ctx = document.getElementById('errorChart').getContext('2d');
        if (myErrorChart) myErrorChart.destroy();
        const errorCounts = sourceData.reduce((acc, row) => {
            const errorCode = row['MÃ LỖI'].trim() || 'Không xác định';
            acc[errorCode] = (acc[errorCode] || 0) + 1;
            return acc;
        }, {});
        const sortedErrors = Object.entries(errorCounts).sort(([, a], [, b]) => b - a).slice(0, 15);
        const labels = sortedErrors.map(item => `Lỗi ${item[0]}`);
        const data = sortedErrors.map(item => item[1]);
        myErrorChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Số lần xuất hiện', data, backgroundColor: 'rgba(0, 123, 255, 0.6)' }] }, options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
    }

    // --- DOMContentLoaded EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        ['MT', 'LOI'].forEach(type => {
            const dropZone = document.getElementById(`dropZone${type}`), fileInput = document.getElementById(`file${type}`), fileNameSpan = document.getElementById(`fileName${type}`);
            if (!dropZone) return;
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => { if (fileInput.files.length) fileNameSpan.textContent = fileInput.files[0].name; });
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; fileNameSpan.textContent = fileInput.files[0].name; } });
        });
        
        document.getElementById('selectAllSource')?.addEventListener('change', function() { document.querySelectorAll('#sourceTableBody input[type="checkbox"]').forEach(checkbox => checkbox.checked = this.checked); });
        document.getElementById('exportTableBody')?.addEventListener('dblclick', (event) => { const cell = event.target.closest('td.editable'); if (cell) makeCellEditable(cell); });
        
        document.querySelectorAll('.collapsible').forEach(button => {
            button.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.display === "block") {
                    content.style.display = "none";
                } else {
                    content.style.display = "block";
                }
            });
        });
        
        document.getElementById('newRuleAction')?.addEventListener('change', function() {
            document.getElementById('standardValueGroup').style.display = this.value === 'STANDARDIZE' ? 'block' : 'none';
        });

        document.querySelectorAll('input[name="chartViewMode"]').forEach(radio => {
            radio.addEventListener('change', updateChartView);
        });
    });
</script>
</body>
</html>